<!DOCTYPE html>
<html lang="ko" style="background: #0f172a;">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#0f172a">
    <title>ArtOfStreet ì•ˆì „ì§€ëŒ€ - Final Fixed</title>
    
    <script type="text/javascript" src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=5d19f896badf6fdab5297f129bffaf1e&libraries=services"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    
    <style>
        /* [ê¸°ë³¸ ìŠ¤íƒ€ì¼] */
        * { 
            margin: 0; padding: 0; box-sizing: border-box; 
            font-family: 'Pretendard', -apple-system, sans-serif;
            -webkit-user-select: none; user-select: none;
            -webkit-tap-highlight-color: transparent; outline: none !important;
        }
        html, body { width: 100%; height: 100%; overflow: hidden; position: fixed; touch-action: manipulation; }
        body { background: #0f172a !important; color: white; }
        
        /* [ìƒë‹¨ í—¤ë”] */
        .top-header { 
            position: fixed; top: 0; left: 0; right: 0; height: 75px; 
            background: #1e1b4b; 
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 15px; z-index: 1000;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .header-title { font-size: 22px; font-weight: 800; color: #f8fafc; }

        .icon-btn {
            width: 48px; height: 48px; display: flex; align-items: center; justify-content: center;
            cursor: pointer; background: rgba(255,255,255,0.05); border-radius: 14px;
            transition: all 0.2s; border: 1px solid rgba(255,255,255,0.1);
        }
        .icon-btn:active { transform: scale(0.9); background: rgba(255,255,255,0.15); }

        /* [ë©”ì¸ í™”ë©´ ë ˆì´ì•„ì›ƒ] */
        .app-screen { 
            display: none; width: 100%; height: 100%; padding-top: 75px; 
            flex-direction: column; align-items: center; overflow-y: auto; 
        }
        .app-screen.active { display: flex; }

        /* [ë°œì‹ ] êµ¬ì¡° ìš”ì²­ ëª¨ë“œ */
        #senderScreen { justify-content: center; padding: 20px; }
        .radar-box { 
            position: relative; width: 310px; height: 310px; 
            display: flex; align-items: center; justify-content: center; 
            margin-bottom: 20px;
        }

        /* ì¨í•œ ë„¤ì˜¨ ê´‘ì±„ */
        .outer-glow {
            position: absolute; width: 92%; height: 92%; border-radius: 50%;
            background: conic-gradient(from 0deg, #ff0000, #ff7f00, #ffff00, #00ff00, #00ffff, #0000ff, #8b00ff, #ff0000);
            box-shadow: 0 0 35px 5px rgba(255, 0, 0, 0.4), 0 0 55px 15px rgba(0, 255, 0, 0.2), 0 0 75px 25px rgba(0, 0, 255, 0.3);
            filter: blur(8px); animation: rotate 4s linear infinite; opacity: 0.9;
        }
        .inner-ring {
            position: absolute; width: 88%; height: 88%; border-radius: 50%;
            background: conic-gradient(from 0deg, #ff0000, #ff7f00, #ffff00, #00ff00, #00ffff, #0000ff, #8b00ff, #ff0000);
            padding: 5px; -webkit-mask: radial-gradient(farthest-side, transparent calc(100% - 6px), #fff calc(100% - 5px));
            animation: rotate 4s linear infinite; z-index: 5;
        }
        @keyframes rotate { 100% { transform: rotate(360deg); } }

        .inner-circle {
            width: 240px; height: 240px; background: #111827; border-radius: 50%;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            box-shadow: inset 0 0 40px rgba(0,0,0,0.9); border: 1px solid rgba(255,255,255,0.1);
            cursor: pointer; z-index: 10;
        }
        .sos-main { font-size: 68px; font-weight: 900; color: white; }
        .sos-sub { font-size: 22px; color: #94a3b8; margin-top: 5px; font-weight: 600; }

        .tracking-badge {
            background: rgba(220, 38, 38, 0.2); color: #ff4d4d; padding: 12px 30px; border-radius: 50px; border: 2px solid #ef4444;
            font-size: 18px; font-weight: 800; margin-top: 40px; box-shadow: 0 0 20px rgba(239, 68, 68, 0.6);
            animation: blink 1.5s infinite; display: flex; align-items: center; gap: 10px;
        }
        @keyframes blink { 50% { opacity: 0.4; } }

        /* [ìˆ˜ì‹ ] ê°€ì¡± ë³´í˜¸ ëª¨ë“œ */
        #receiverScreen { background: #064e3b; padding: 20px; }
        #receiverScreen.emergency { background: #991b1b !important; }
        .receiver-title { font-size: 28px; margin: 20px 0; font-weight: 900; text-align: center; }
        #map { width: 100%; height: 320px; border-radius: 20px; border: 3px solid rgba(255,255,255,0.2); margin-bottom: 20px; }
        .status-card { background: rgba(255,255,255,0.1); padding: 20px; border-radius: 20px; text-align: center; width: 100%; border: 1px solid rgba(255,255,255,0.2); }

        /* [ì„¤ì • ë ˆì´ì–´] */
        .settings-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #0f172a; z-index: 10000; padding: 85px 20px 20px; }
        .settings-overlay.active { display: block; }
        .card { background: #1e293b; padding: 20px; border-radius: 20px; border: 1px solid #334155; margin-bottom: 20px; }
        .id-text { font-size: 32px; color: #60a5fa; font-weight: 900; text-align: center; display: block; }
        .btn-white { background: white; color: #0f172a; padding: 15px; border-radius: 12px; border: none; font-weight: bold; width: 100%; cursor: pointer; margin-top: 10px; }
        
        .input-box { width: 100%; padding: 15px; border-radius: 12px; border: 2px solid #334155; font-size: 18px; text-align: center; background: #0f172a; color: white; margin: 10px 0; }
    </style>
</head>
<body>

    <header class="top-header">
        <div class="icon-btn" id="modeToggleBtn" onclick="handleModeToggle()">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5"><path d="M7 16l-4-4 4-4M3 12h18M17 8l4 4-4 4"/></svg>
        </div>
        <div class="header-title" id="headerTitle">SOS ìš”ì²­ ëª¨ë“œ</div>
        <div class="icon-btn" id="settingsBtn" onclick="handleSettingsShow()">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0a2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>
        </div>
    </header>

    <main id="senderScreen" class="app-screen active">
        <div class="radar-box">
            <div class="outer-glow"></div>
            <div class="inner-ring"></div>
            <div class="inner-circle" id="sosBtn" onclick="handleSOS()">
                <div class="sos-main">SOS</div>
                <div class="sos-sub">êµ¬ì¡°ìš”ì²­</div>
            </div>
        </div>
        <div id="statusMsg"></div>
        <div id="trackingBadge" class="tracking-badge" style="display:none;">ğŸ“ ì‹¤ì‹œê°„ ìœ„ì¹˜ ì¶”ì  ì¤‘</div>
    </main>

    <main id="receiverScreen" class="app-screen">
        <h1 class="receiver-title">SOS ì§€ì› ëª¨ë“œ</h1>
        <div id="map"></div>
        <div class="status-card">
            <p id="recvStatus" style="font-size: 18px;">ê°€ì¡±ì˜ ì‹ í˜¸ë¥¼ ê¸°ë‹¤ë¦¬ëŠ” ì¤‘...</p>
        </div>
        <button class="btn-white" id="soundBtn" onclick="handleSirenReady()">ğŸ”Š ì‚¬ì´ë Œ ì¤€ë¹„</button>
        <button class="btn-white" id="stopSiren" onclick="handleStopSiren()" style="display:none; background:#dc2626; color:white;">ì‚¬ì´ë Œ ì •ì§€</button>
    </main>

    <div id="settingsOverlay" class="settings-overlay">
        <div class="card">
            <h3 style="margin-bottom:10px;">ë‚´ ê¸°ê¸° ê³ ìœ  ID</h3>
            <span class="id-text" id="myIdText">...</span>
        </div>
        <div class="card">
            <h3>ğŸ‘¥ ì—°ê²° ê´€ë¦¬</h3>
            <input type="text" id="friendInput" class="input-box" placeholder="ìƒëŒ€ ID ì…ë ¥">
            <button class="btn-white" id="addFriendBtn" onclick="handleAddFriend()" style="background:#2563eb; color:white;">ì—°ê²° ì¶”ê°€í•˜ê¸°</button>
        </div>
        <button class="btn-white" id="closeSettingsBtn" onclick="handleSettingsHide()">ë‹«ê¸°</button>
    </div>

    <script>
        // ì „ì—­ ë³€ìˆ˜ ë¨¼ì € ì„ ì–¸
        var currentMode = 'sender';
        var isTracking = false;
        var watchId = null;
        var map, marker, siren, sirenReady = false;
        var db, geocoder, myID;

        // ì „ì—­ í•¨ìˆ˜ë“¤
        function handleModeToggle() {
            currentMode = (currentMode === 'sender') ? 'receiver' : 'sender';
            document.getElementById('headerTitle').innerText = (currentMode === 'sender') ? 'SOS ìš”ì²­ ëª¨ë“œ' : 'SOS ì§€ì› ëª¨ë“œ';
            document.getElementById('senderScreen').classList.toggle('active');
            document.getElementById('receiverScreen').classList.toggle('active');
            if (currentMode === 'receiver') {
                setTimeout(() => { map.relayout(); startListening(); }, 300);
            }
        }

        function handleSettingsShow() {
            document.getElementById('settingsOverlay').classList.add('active');
        }

        function handleSettingsHide() {
            document.getElementById('settingsOverlay').classList.remove('active');
        }

        function handleAddFriend() {
            const input = document.getElementById('friendInput');
            if(input.value) {
                let list = JSON.parse(localStorage.getItem('friendList_RCV') || '[]');
                list.push(input.value.toUpperCase());
                localStorage.setItem('friendList_RCV', JSON.stringify(list));
                input.value = '';
                alert('ê°€ì¡±ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!');
            }
        }

        function handleSOS() {
            if(!isTracking) {
                isTracking = true;
                document.querySelector('.radar-box').classList.add('tracking');
                document.getElementById('trackingBadge').style.display = 'flex';
                if(navigator.vibrate) navigator.vibrate([200, 100, 200]);
                watchId = navigator.geolocation.watchPosition(pos => {
                    const lat = pos.coords.latitude, lon = pos.coords.longitude;
                    geocoder.coord2Address(lon, lat, (res, status) => {
                        let addr = (status === kakao.maps.services.Status.OK) ? res[0].address.address_name : 'ìœ„ì¹˜ íŒŒì•… ì¤‘';
                        db.ref('emergency_global').set({ sender: myID, lat, lon, address: addr, time: new Date().toLocaleTimeString() });
                    });
                }, null, { enableHighAccuracy: true });
            } else {
                isTracking = false;
                navigator.geolocation.clearWatch(watchId);
                db.ref('emergency_global').remove();
                document.querySelector('.radar-box').classList.remove('tracking');
                document.getElementById('trackingBadge').style.display = 'none';
            }
        }

        function handleSirenReady() {
            siren.play().then(() => { 
                siren.pause(); 
                sirenReady = true; 
                document.getElementById('soundBtn').innerText = "âœ… ì‚¬ì´ë Œ ê°ì‹œ ì¤‘"; 
                document.getElementById('soundBtn').style.background = "#10b981"; 
            });
        }

        function handleStopSiren() {
            hideEmergency();
        }

        function startListening() {
            db.ref('emergency_global').on('value', (snap) => {
                const data = snap.val();
                if(data) {
                    const pos = new kakao.maps.LatLng(data.lat, data.lon);
                    map.setCenter(pos); 
                    marker.setPosition(pos);
                    document.getElementById('recvStatus').innerHTML = `ğŸš¨ <strong>${data.sender}</strong>ë‹˜ SOS ìš”ì²­!<br>ìœ„ì¹˜: ${data.address}`;
                    if(sirenReady) siren.play();
                    document.getElementById('receiverScreen').classList.add('emergency');
                    document.getElementById('stopSiren').style.display = "block";
                } else {
                    hideEmergency();
                }
            });
        }

        function hideEmergency() {
            siren.pause();
            document.getElementById('receiverScreen').classList.remove('emergency');
            document.querySelector('.receiver-title').innerText = "âœ… í˜„ì¬ ì•ˆì „í•©ë‹ˆë‹¤";
            document.getElementById('recvStatus').innerText = "ê°€ì¡±ì˜ ì‹ í˜¸ë¥¼ ê¸°ë‹¤ë¦¬ëŠ” ì¤‘...";
            document.getElementById('stopSiren').style.display = "none";
        }

        // í˜ì´ì§€ ë¡œë“œ ì™„ë£Œ í›„ ì´ˆê¸°í™”
        window.onload = function() {
            // Firebase ì´ˆê¸°í™”
            const firebaseConfig = {
                apiKey: "AIzaSyCJnlwuftFUmmazQg-riYRewSeKRjBB8g",
                databaseURL: "https://safezone-2c1b2-default-rtdb.firebaseio.com",
                projectId: "safezone-2c1b2",
                appId: "1:181205095456:web:da0a519ff43cc19e7b1845"
            };
            firebase.initializeApp(firebaseConfig);
            db = firebase.database();
            geocoder = new kakao.maps.services.Geocoder();

            // ID ì´ˆê¸°í™”
            myID = localStorage.getItem('safeZoneID_V19') || 'SZ-' + Math.random().toString(36).substr(2, 4).toUpperCase();
            localStorage.setItem('safeZoneID_V19', myID);
            document.getElementById('myIdText').innerText = myID;
            
            // ì§€ë„ ì´ˆê¸°í™”
            map = new kakao.maps.Map(document.getElementById('map'), { 
                center: new kakao.maps.LatLng(37.5665, 126.9780), 
                level: 3 
            });
            marker = new kakao.maps.Marker({ position: map.getCenter() });
            marker.setMap(map);
            window.kakaoMap = map;

            // ì‚¬ì´ë Œ ì´ˆê¸°í™”
            siren = new Audio('https://actions.google.com/sounds/v1/alarms/siren_wailing.ogg');
            siren.loop = true;
        };
    </script>
</body>
</html>
