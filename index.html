<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#0f172a">
    <title>ë¸”ë™ì•„ì›ƒ ê°€ë””ì–¸ - Premium</title>
    
    <script type="text/javascript" src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=5d19f896badf6fdab5297f129bffaf1e&libraries=services"></script>
    
    <style>
        * { 
            margin: 0; padding: 0; box-sizing: border-box; 
            font-family: 'Pretendard', -apple-system, sans-serif;
            -webkit-user-select: none; user-select: none;
            -webkit-tap-highlight-color: transparent; outline: none !important;
        }
        html, body { 
            width: 100%; height: 100%; 
            background-color: #0f172a; /* ë”¥ ë„¤ì´ë¹„ ë°°ê²½ */
            color: white; overflow: hidden;
        }
        
        /* ìƒë‹¨ í—¤ë” */
        .top-header { 
            position: fixed; top: 0; left: 0; right: 0; height: 70px; 
            background: #1e1b4b; 
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 15px; z-index: 1000;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .header-title { font-size: 20px; font-weight: 700; color: #cbd5e1; }

        /* SVG ì•„ì´ì½˜ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .icon-btn {
            width: 40px; height: 40px; display: flex; align-items: center; justify-content: center;
            cursor: pointer; opacity: 0.8;
        }
        .icon-btn:active { opacity: 0.6; }

        /* ë©”ì¸ í™”ë©´ */
        .app-screen {
            display: none; /* ê¸°ë³¸ ìˆ¨ê¹€ */
            width: 100%; height: 100%;
            padding-top: 70px; flex-direction: column; align-items: center;
            overflow-y: auto; touch-action: pan-y;
        }
        .app-screen.active { display: flex; } /* í™œì„±í™” ì‹œ ë³´ì„ */

        /* ë°œì‹  í™”ë©´ - SOS ë²„íŠ¼ */
        #senderScreen { justify-content: center; }
        .radar-box {
            position: relative; width: 280px; height: 280px;
            display: flex; align-items: center; justify-content: center;
        }
        .outer-glow {
            position: absolute; width: 100%; height: 100%; border-radius: 50%;
            background: conic-gradient(from 0deg, #ff0000, #ff7f00, #ffff00, #00ff00, #00ffff, #0000ff, #8b00ff, #ff0000);
            padding: 8px; /* ë ì˜ ë‘ê»˜ */
            -webkit-mask: radial-gradient(farthest-side, transparent calc(100% - 8px), #fff calc(100% - 7px));
            mask: radial-gradient(farthest-side, transparent calc(100% - 8px), #fff calc(100% - 7px));
            animation: rotate 4s linear infinite;
            filter: blur(1px) drop-shadow(0 0 12px rgba(255, 255, 255, 0.4));
        }
        @keyframes rotate { 100% { transform: rotate(360deg); } }

        .inner-circle {
            position: absolute; width: 240px; height: 240px;
            background: #111827; border-radius: 50%;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            box-shadow: inset 0 0 30px rgba(0,0,0,0.8), 0 0 20px rgba(255,255,255,0.05);
            border: 2px solid rgba(255,255,255,0.1);
        }

        .sos-main { font-size: 64px; font-weight: 900; letter-spacing: 2px; line-height: 1; }
        .sos-sub { font-size: 20px; font-weight: 500; margin-top: 10px; color: #94a3b8; }

        /* í•˜ë‹¨ ìœ„ì¹˜ ì¶”ì  ë„¤ì˜¨ ë°°ì§€ */
        .tracking-badge {
            background: rgba(220, 38, 38, 0.15); color: #ff4d4d;
            padding: 12px 30px; border-radius: 50px; border: 2px solid #ef4444;
            font-size: 18px; font-weight: 800; margin-top: 40px;
            box-shadow: 0 0 15px rgba(239, 68, 68, 0.5);
            animation: blink 1s infinite;
            display: flex; align-items: center; gap: 10px;
        }
        @keyframes blink { 50% { opacity: 0.5; } }

        /* ìˆ˜ì‹  í™”ë©´ */
        #receiverScreen { background: #064e3b; padding: 20px; }
        .receiver-title { font-size: 32px; margin: 25px 0; font-weight: 900; }
        #map { width: 100%; height: 350px; border-radius: 20px; margin: 20px 0; border: 3px solid rgba(255,255,255,0.3); }
        .status-card { background: rgba(255,255,255,0.15); padding: 25px; border-radius: 20px; width: 90%; max-width: 400px; text-align: center; backdrop-filter: blur(10px); }

        /* ê³µí†µ ë²„íŠ¼ */
        .btn-action { width: 90%; padding: 18px; border-radius: 15px; border: none; font-weight: bold; font-size: 18px; margin: 10px 0; cursor: pointer; }
        .btn-red { background: #dc2626; color: white; box-shadow: 0 4px 15px rgba(220, 38, 38, 0.4); }
        .btn-green { background: #10b981; color: white; box-shadow: 0 4px 15px rgba(16, 185, 129, 0.4); }
        .btn-white { background: white; color: #047857; font-weight: 900; box-shadow: 0 4px 15px rgba(0,0,0,0.2); }

        /* ì„¤ì • í™”ë©´ */
        .settings-screen { display: none; position: absolute; top: 80px; left: 0; width: 100%; height: calc(100% - 80px); padding: 20px; overflow-y: auto; z-index: 8888; }
        .settings-screen.active { display: block; }
        .sender-settings { background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%); }
        .receiver-settings { background: linear-gradient(135deg, #064e3b 0%, #047857 100%); }
        .card { background: rgba(255,255,255,0.1); padding: 28px; border-radius: 20px; width: 100%; max-width: 450px; margin: 0 auto 25px; border: 2px solid rgba(255,255,255,0.2); backdrop-filter: blur(10px); }
        .id-display { background: rgba(59, 130, 246, 0.2); padding: 18px; border-radius: 15px; margin: 15px 0; text-align: center; border: 2px solid rgba(59, 130, 246, 0.3); }
        .id-text { font-size: 38px; color: #60a5fa; font-weight: 900; letter-spacing: 4px; }
    </style>
</head>
<body>

    <header class="top-header">
        <div class="icon-btn mode-toggle-btn" onclick="toggleMode()">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#cbd5e1" stroke-width="2"><path d="M7 16l-4-4 4-4M3 12h18M17 8l4 4-4 4"/></svg>
        </div>
        <div class="header-title" id="headerTitle">êµ¬ì¡° ìš”ì²­ ëª¨ë“œ</div>
        <div class="icon-btn settings-btn" onclick="showSettings()">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#cbd5e1" stroke-width="2"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 a2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>
        </div>
    </header>

    <main id="senderScreen" class="app-screen active">
        <div class="radar-box">
            <div class="outer-glow"></div>
            <div class="inner-circle" id="sosBtn">
                <div class="sos-main">SOS</div>
                <div class="sos-sub">êµ¬ì¡°ìš”ì²­</div>
            </div>
        </div>
        <div id="trackingBadge" class="tracking-badge" style="display:none;">ğŸ“ ì‹¤ì‹œê°„ ì¶”ì  ì¤‘</div>
    </main>

    <main id="receiverScreen" class="app-screen">
        <h1 class="receiver-title">ê°€ì¡± ë³´í˜¸ ì„¼í„°</h1>
        <div id="map"></div>
        <div class="status-card">
            <p id="recvStatus">ê°€ì¡±ì˜ ì‹ í˜¸ë¥¼ ê¸°ë‹¤ë¦¬ëŠ” ì¤‘...</p>
        </div>
        <button class="btn-action btn-red" id="stopSiren" style="display:none;">ğŸ”Š ì‚¬ì´ë Œ ì •ì§€</button>
    </main>

    <div id="senderSettings" class="settings-screen sender-settings">
        <h1 style="text-align:center; margin-bottom:25px;">ë°œì‹  ì„¤ì •</h1>
        <div class="card">
            <p class="section-title" style="color:white;">ë‚´ ì•ˆì „ ID</p>
            <div class="id-display"><div class="id-text" id="senderId">...</div></div>
        </div>
        <div class="card">
            <p class="section-title" style="color:white;">ğŸ‘¥ ë³´í˜¸ì ë“±ë¡</p>
            <input type="text" id="senderFriendInput" class="input-box" placeholder="ì˜ˆ: SZ-A1B2" maxlength="15">
            <button class="btn-add" onclick="addSenderFriend()">ë“±ë¡í•˜ê¸°</button>
        </div>
        <div id="senderFriendList" class="card"></div>
        <button class="btn-white" onclick="hideSettings()">â† ëŒì•„ê°€ê¸°</button>
    </div>

    <div id="receiverSettings" class="settings-screen receiver-settings">
        <h1 style="text-align:center; margin-bottom:25px;">ìˆ˜ì‹  ì„¤ì •</h1>
        <div class="card">
            <p class="section-title" style="color:white;">ë‚´ ê³ ìœ  ID</p>
            <div class="id-display"><div class="id-text" id="receiverId">...</div></div>
        </div>
        <div class="card">
            <p class="section-title" style="color:white;">ğŸ‘¥ ê°€ì¡± ë“±ë¡</p>
            <input type="text" id="receiverFriendInput" class="input-box" placeholder="ì˜ˆ: SZ-A1B2" maxlength="15">
            <button class="btn-add" onclick="addReceiverFriend()">ë“±ë¡í•˜ê¸°</button>
        </div>
        <div id="receiverFriendList" class="card"></div>
        <button class="btn-white" onclick="hideSettings()">â† ëŒì•„ê°€ê¸°</button>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
        import { getDatabase, ref, set, remove, onValue } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCJnlwuftFUmmazQg-riYRewSeKRjBB8g",
            databaseURL: "https://safezone-2c1b2-default-rtdb.firebaseio.com",
            projectId: "safezone-2c1b2",
            appId: "1:181205095456:web:da0a519ff43cc19e7b1845"
        };
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const geocoder = new kakao.maps.services.Geocoder();

        let myID = localStorage.getItem('safeZoneID') || 'SZ-' + Math.random().toString(36).substr(2, 4).toUpperCase();
        localStorage.setItem('safeZoneID', myID);
        document.getElementById('senderId').innerText = myID;
        document.getElementById('receiverId').innerText = myID;

        let mode = 'sender';
        let isTracking = false;
        let watchId = null;

        // ëª¨ë“œ ì „í™˜ í•¨ìˆ˜ (ì™¸ë¶€ì—ì„œ í˜¸ì¶œ ê°€ëŠ¥)
        window.toggleMode = function() {
            mode = (mode === 'sender') ? 'receiver' : 'sender';
            document.getElementById('headerTitle').innerText = (mode === 'sender') ? 'êµ¬ì¡° ìš”ì²­ ëª¨ë“œ' : 'ê°€ì¡± ë³´í˜¸ ëª¨ë“œ';
            document.getElementById('senderScreen').classList.toggle('active');
            document.getElementById('receiverScreen').classList.toggle('active');
            if (mode === 'receiver') {
                setTimeout(() => { map.relayout(); }, 300);
                startListening();
            } else {
                stopListening(); // ë°œì‹  ëª¨ë“œë¡œ ì „í™˜ ì‹œ ìˆ˜ì‹  ë¦¬ìŠ¤ë„ˆ ì¤‘ì§€
            }
        };

        // ì„¤ì •ì°½ í•¨ìˆ˜ (ì™¸ë¶€ì—ì„œ í˜¸ì¶œ ê°€ëŠ¥)
        window.showSettings = () => {
            if(mode === 'sender') document.getElementById('senderSettings').classList.add('active');
            else document.getElementById('receiverSettings').classList.add('active');
        };
        window.hideSettings = () => {
            document.querySelectorAll('.settings-screen').forEach(s => s.classList.remove('active'));
        };

        // ë°œì‹  ë¡œì§
        document.getElementById('sosBtn').onclick = function() {
            if (!isTracking) {
                isTracking = true;
                this.parentElement.classList.add('tracking'); // SOS ë²„íŠ¼ ì• ë‹ˆë©”ì´ì…˜
                document.getElementById('trackingBadge').style.display = 'flex';
                
                if (navigator.vibrate) navigator.vibrate([200, 100, 200]);

                watchId = navigator.geolocation.watchPosition((pos) => {
                    const lat = pos.coords.latitude; const lon = pos.coords.longitude;
                    geocoder.coord2Address(lon, lat, (res, status) => {
                        let addr = (status === kakao.maps.services.Status.OK && res[0]) ? res[0].address.address_name : 'ìœ„ì¹˜ í™•ì¸ ë¶ˆê°€';
                        set(ref(db, 'emergency_global'), {
                            sender: myID, address: addr, lat: lat, lon: lon,
                            mapUrl: `https://map.kakao.com/link/map/ê¸´ê¸‰êµ¬ì¡°,${lat},${lon}`,
                            time: new Date().toLocaleTimeString()
                        });
                    });
                }, (error) => { alert('ìœ„ì¹˜ ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ' + error.message); }, { enableHighAccuracy: true });
            } else {
                isTracking = false;
                if (watchId) navigator.geolocation.clearWatch(watchId);
                remove(ref(db, 'emergency_global'));
                this.parentElement.classList.remove('tracking');
                document.getElementById('trackingBadge').style.display = 'none';
            }
        };

        // ìˆ˜ì‹  ë¡œì§ & ì§€ë„
        const map = new kakao.maps.Map(document.getElementById('map'), { center: new kakao.maps.LatLng(37.5665, 126.9780), level: 3 });
        const marker = new kakao.maps.Marker({ position: map.getCenter() });
        marker.setMap(map);
        window.kakaoMap = map;

        const siren = new Audio('https://actions.google.com/sounds/v1/alarms/siren_wailing.ogg');
        siren.loop = true;
        let sirenReady = false;
        document.body.addEventListener('click', () => {
             if (!sirenReady) {
                siren.play().then(() => { siren.pause(); sirenReady = true; }).catch(() => {});
            }
        }, { once: true });

        let currentListener = null;

        function startListening() {
            const fList = JSON.parse(localStorage.getItem('friendList_RCV') || '[]');
            currentListener = onValue(ref(db, 'emergency_global'), (snap) => {
                const data = snap.val();
                if(data) {
                    if(fList.includes(data.sender)) {
                        showEmergency(data);
                    } else {
                        // ë“±ë¡ë˜ì§€ ì•Šì€ ì¹œêµ¬ì˜ ì‹ í˜¸ëŠ” ë¬´ì‹œ
                    }
                } else {
                    hideEmergency();
                }
            });
        }

        function stopListening() {
            if (currentListener) {
                currentListener(); // ë¦¬ìŠ¤ë„ˆ í•´ì œ (off()ì™€ ë™ì¼)
                currentListener = null;
            }
        }

        function showEmergency(data) {
            if(sirenReady) siren.play().catch(() => {});
            document.getElementById('receiverScreen').classList.add('emergency');
            document.getElementById('receiverTitle').innerText = "ğŸš¨ ê¸´ê¸‰ ìƒí™©!!";
            document.getElementById('recvStatus').innerHTML = `<strong>${data.sender}</strong>ë‹˜ ìœ„í—˜!<br>ìœ„ì¹˜: ${data.address}<br>ì‹œê°„: ${data.time}`;
            document.getElementById('stopSiren').style.display = "block";
            
            const pos = new kakao.maps.LatLng(data.lat, data.lon);
            window.kakaoMap.setCenter(pos); window.marker.setPosition(pos);
        }

        function hideEmergency() {
            siren.pause(); siren.currentTime = 0;
            document.getElementById('receiverScreen').classList.remove('emergency');
            document.getElementById('receiverTitle').innerText = "ê°€ì¡± ë³´í˜¸ ì„¼í„°";
            document.getElementById('recvStatus').innerText = "ê°€ì¡±ì˜ ì‹ í˜¸ë¥¼ ê¸°ë‹¤ë¦¬ëŠ” ì¤‘...";
            document.getElementById('stopSiren').style.display = "none";
        }

        document.getElementById('stopSiren').onclick = () => {
            siren.pause(); siren.currentTime = 0;
        };
        
        // ì¹œêµ¬ ê´€ë¦¬ (ê°„ì†Œí™” - ì‹¤ì œ êµ¬í˜„ ì‹œì—ëŠ” ë” ìƒì„¸í•˜ê²Œ)
        window.addSenderFriend = () => {
             const input = document.getElementById('senderFriendInput');
             const id = input.value.trim().toUpperCase();
             if(id) {
                 let list = JSON.parse(localStorage.getItem('friendList_SND') || '[]');
                 if(!list.includes(id)) { list.push(id); localStorage.setItem('friendList_SND', JSON.stringify(list)); }
                 input.value = '';
                 loadSenderFriends();
             }
        };
         window.addReceiverFriend = () => {
             const input = document.getElementById('receiverFriendInput');
             const id = input.value.trim().toUpperCase();
             if(id) {
                 let list = JSON.parse(localStorage.getItem('friendList_RCV') || '[]');
                 if(!list.includes(id)) { list.push(id); localStorage.setItem('friendList_RCV', JSON.stringify(list)); }
                 input.value = '';
                 loadReceiverFriends();
             }
        };
        function loadSenderFriends() { /* (ì´ì „ ì½”ë“œ ì°¸ì¡° - ì¹œêµ¬ ëª©ë¡ í‘œì‹œ ë¡œì§ êµ¬í˜„) */ }
        function loadReceiverFriends() { /* (ì´ì „ ì½”ë“œ ì°¸ì¡° - ì¹œêµ¬ ëª©ë¡ í‘œì‹œ ë¡œì§ êµ¬í˜„) */ }

    </script>
</body>
</html>
