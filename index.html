<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#0f172a">
    <title>ArtOfStreet ì•ˆì „ì§€ëŒ€ - Premium</title>
    
    <script type="text/javascript" src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=5d19f896badf6fdab5297f129bffaf1e&libraries=services"></script>
    
    <style>
        /* [ê¸°ë³¸ ìŠ¤íƒ€ì¼] */
        * { 
            margin: 0; padding: 0; box-sizing: border-box; 
            font-family: 'Pretendard', -apple-system, sans-serif;
            -webkit-user-select: none;
        }
        html, body { 
            width: 100%; height: 100%; 
            background-color: #0f172a; /* ë”¥ ë„¤ì´ë¹„ ë°°ê²½ */
            color: white; overflow: hidden;
        }
        
        /* [ìƒë‹¨ í—¤ë”] */
        .top-header { 
            position: fixed; top: 0; left: 0; right: 0; height: 70px; 
            background: #1e1b4b; 
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 15px; z-index: 1000;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .header-title { font-size: 20px; font-weight: 700; color: #cbd5e1; }

        .icon-btn {
            width: 45px; height: 45px; display: flex; align-items: center; justify-content: center;
            cursor: pointer; background: rgba(255,255,255,0.05); border-radius: 10px;
        }

        /* [ë©”ì¸ ì»¨í…Œì´ë„ˆ] */
        .app-screen {
            display: none; /* ê¸°ë³¸ ìˆ¨ê¹€ */
            width: 100%; height: 100%;
            padding-top: 70px; flex-direction: column; align-items: center;
            overflow-y: auto;
        }
        .app-screen.active { display: flex; } /* í™œì„±í™” ì‹œ ë³´ì„ */

        /* [ë°œì‹  í™”ë©´ ë””ìì¸] */
        #senderScreen { justify-content: center; }
        .ver-text { font-size: 12px; color: #64748b; margin-bottom: 30px; }
        
        .radar-box { position: relative; width: 280px; height: 280px; display: flex; align-items: center; justify-content: center; }
        .outer-glow {
            position: absolute; width: 100%; height: 100%; border-radius: 50%; padding: 6px;
            background: conic-gradient(from 0deg, #ff0000, #ff7f00, #ffff00, #00ff00, #00ffff, #0000ff, #8b00ff, #ff0000);
            -webkit-mask: radial-gradient(farthest-side, transparent calc(100% - 7px), #fff calc(100% - 6px));
            animation: rotate 4s linear infinite;
            filter: drop-shadow(0 0 10px rgba(255, 255, 255, 0.3));
        }
        @keyframes rotate { 100% { transform: rotate(360deg); } }

        .inner-circle {
            width: 230px; height: 230px; background: #111827; border-radius: 50%;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            box-shadow: inset 0 0 25px rgba(0,0,0,0.8); border: 1px solid rgba(255,255,255,0.1);
            cursor: pointer; z-index: 10;
        }
        .sos-main { font-size: 60px; font-weight: 900; }
        .sos-sub { font-size: 18px; color: #94a3b8; }

        .tracking-badge {
            margin-top: 40px; background: rgba(239, 68, 68, 0.1); border: 2px solid #ef4444;
            padding: 10px 25px; border-radius: 30px; color: #ef4444; font-weight: 700;
            box-shadow: 0 0 15px rgba(239, 68, 68, 0.3); animation: blink 1.5s infinite;
        }
        @keyframes blink { 50% { opacity: 0.5; } }

        /* [ìˆ˜ì‹  í™”ë©´ ë””ìì¸] */
        #receiverScreen { background: #064e3b; }
        #map { width: 90%; height: 300px; border-radius: 20px; margin: 20px 0; border: 2px solid rgba(255,255,255,0.2); }
        .status-card { width: 90%; background: rgba(255,255,255,0.1); padding: 20px; border-radius: 20px; text-align: center; }

        /* [ê³µí†µ ë²„íŠ¼] */
        .btn-action { width: 90%; padding: 18px; border-radius: 15px; border: none; font-weight: bold; font-size: 18px; margin: 10px 0; cursor: pointer; }
        .btn-red { background: #dc2626; color: white; }
        .btn-green { background: #10b981; color: white; }

        /* [ì„¤ì • í™”ë©´] */
        .settings-screen { display: none; position: fixed; top: 70px; width: 100%; height: 100%; background: #0f172a; z-index: 2000; padding: 20px; }
        .settings-screen.active { display: block; }
        .card { background: #1e293b; padding: 20px; border-radius: 15px; margin-bottom: 20px; border: 1px solid #334155; }
    </style>
</head>
<body>

    <header class="top-header">
        <div class="icon-btn" onclick="toggleMode()">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#cbd5e1" stroke-width="2"><path d="M7 16l-4-4 4-4M3 12h18M17 8l4 4-4 4"/></svg>
        </div>
        <div class="header-title" id="headerTitle">êµ¬ì¡° ìš”ì²­ ëª¨ë“œ</div>
        <div class="icon-btn" onclick="showSettings()">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#cbd5e1" stroke-width="2"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0a2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>
        </div>
    </header>

    <main id="senderScreen" class="app-screen active">
        <div class="ver-text">Blackout Guardian V19.3 - Premium Edition</div>
        <div class="radar-box">
            <div class="outer-glow"></div>
            <div class="inner-circle" id="sosBtn">
                <div class="sos-main">SOS</div>
                <div class="sos-sub">êµ¬ì¡°ìš”ì²­</div>
            </div>
        </div>
        <div id="statusMsg">ëŒ€ê¸° ì¤‘</div>
        <div id="trackingBadge" class="tracking-badge" style="display:none;">ğŸ“ ì‹¤ì‹œê°„ ì¶”ì  ì¤‘</div>
    </main>

    <main id="receiverScreen" class="app-screen">
        <h1 class="receiver-title">ê°€ì¡± ë³´í˜¸ ì„¼í„°</h1>
        <div id="map"></div>
        <div class="status-card">
            <p id="recvStatus">ê°€ì¡±ì˜ ì‹ í˜¸ë¥¼ ê¸°ë‹¤ë¦¬ëŠ” ì¤‘...</p>
        </div>
        <button class="btn-action btn-red" id="stopSiren" style="display:none;">ì‚¬ì´ë Œ ì •ì§€</button>
    </main>

    <div id="settingsScreen" class="settings-screen">
        <div class="card">
            <h3>ë‚´ ê³ ìœ  ID</h3>
            <div class="id-display"><span class="id-text" id="myIdDisplay">SZ-0000</span></div>
        </div>
        <button class="btn-action btn-green" onclick="hideSettings()">ë‹«ê¸°</button>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
        import { getDatabase, ref, set, remove, onValue } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCJnlwuftFUmmazQg-riYRewSeKRjBB8g",
            databaseURL: "https://safezone-2c1b2-default-rtdb.firebaseio.com",
            projectId: "safezone-2c1b2",
            appId: "1:181205095456:web:da0a519ff43cc19e7b1845"
        };
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const geocoder = new kakao.maps.services.Geocoder();

        let myID = localStorage.getItem('safeZoneID') || 'SZ-' + Math.random().toString(36).substr(2, 4).toUpperCase();
        localStorage.setItem('safeZoneID', myID);
        document.getElementById('myIdDisplay').innerText = myID;

        let mode = 'sender';
        let isTracking = false;
        let watchId = null;

        // ëª¨ë“œ ì „í™˜ í•¨ìˆ˜
        window.toggleMode = function() {
            mode = (mode === 'sender') ? 'receiver' : 'sender';
            document.getElementById('headerTitle').innerText = (mode === 'sender') ? 'êµ¬ì¡° ìš”ì²­ ëª¨ë“œ' : 'ê°€ì¡± ë³´í˜¸ ëª¨ë“œ';
            document.getElementById('senderScreen').classList.toggle('active');
            document.getElementById('receiverScreen').classList.toggle('active');
            if (mode === 'receiver') {
                setTimeout(() => { map.relayout(); }, 300);
                startListening();
            }
        };

        // ì„¤ì •ì°½ í•¨ìˆ˜
        window.showSettings = () => document.getElementById('settingsScreen').classList.add('active');
        window.hideSettings = () => document.getElementById('settingsScreen').classList.remove('active');

        // ë°œì‹  ë¡œì§
        document.getElementById('sosBtn').onclick = function() {
            if(!isTracking) {
                isTracking = true;
                this.parentElement.classList.add('tracking');
                document.getElementById('trackingBadge').style.display = 'block';
                watchId = navigator.geolocation.watchPosition(pos => {
                    const lat = pos.coords.latitude, lon = pos.coords.longitude;
                    set(ref(db, 'emergency_global'), { sender: myID, lat, lon, time: new Date().toLocaleTimeString() });
                    document.getElementById('statusMsg').innerText = "ğŸ“ ì‹ í˜¸ ì „ì†¡ ì¤‘...";
                });
            } else {
                isTracking = false;
                navigator.geolocation.clearWatch(watchId);
                remove(ref(db, 'emergency_global'));
                document.getElementById('trackingBadge').style.display = 'none';
                document.getElementById('statusMsg').innerText = "ëŒ€ê¸° ì¤‘";
            }
        };

        // ìˆ˜ì‹  ë¡œì§ & ì§€ë„
        const map = new kakao.maps.Map(document.getElementById('map'), { center: new kakao.maps.LatLng(37.5665, 126.9780), level: 3 });
        const marker = new kakao.maps.Marker({ position: map.getCenter() });
        marker.setMap(map);
        window.kakaoMap = map;

        function startListening() {
            onValue(ref(db, 'emergency_global'), (snap) => {
                const data = snap.val();
                if(data) {
                    const pos = new kakao.maps.LatLng(data.lat, data.lon);
                    map.setCenter(pos); marker.setPosition(pos);
                    document.getElementById('recvStatus').innerText = `ğŸš¨ ${data.sender}ë‹˜ ìœ„í—˜!`;
                } else {
                    document.getElementById('recvStatus').innerText = "âœ… ëª¨ë‘ ì•ˆì „í•©ë‹ˆë‹¤";
                }
            });
        }
    </script>
</body>
</html>
