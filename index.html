<!DOCTYPE html>
<html lang="ko" style="background: #0f172a;">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#0f172a">
    <title>ArtOfStreet ì•ˆì „ì§€ëŒ€ - Premium Edition</title>
    
    <script type="text/javascript" src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=5d19f896badf6fdab5297f129bffaf1e&libraries=services"></script>
    
    <style>
        /* ê¸°ë³¸ ì„¤ì • */
        * { 
            margin: 0; padding: 0; box-sizing: border-box; 
            font-family: 'Pretendard', -apple-system, sans-serif;
            -webkit-user-select: none; user-select: none;
            -webkit-tap-highlight-color: transparent; outline: none !important;
        }
        html, body { width: 100%; height: 100%; overflow: hidden; position: fixed; touch-action: manipulation; }
        body { background: #0f172a !important; color: white; }
        
        /* ìƒë‹¨ í—¤ë” */
        .top-header { 
            position: fixed; top: 0; left: 0; right: 0; height: 75px; 
            background: #1e1b4b; 
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 15px; z-index: 1000;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .header-title { font-size: 22px; font-weight: 800; color: #f8fafc; }

        .icon-btn {
            width: 48px; height: 48px; display: flex; align-items: center; justify-content: center;
            cursor: pointer; background: rgba(255,255,255,0.05); border-radius: 14px;
            transition: all 0.2s; border: 1px solid rgba(255,255,255,0.1);
        }
        .icon-btn:active { transform: scale(0.9); background: rgba(255,255,255,0.15); }

        /* ë©”ì¸ í™”ë©´ ë ˆì´ì•„ì›ƒ */
        .app-screen { 
            display: none; width: 100%; height: 100%; padding-top: 75px; 
            flex-direction: column; align-items: center; overflow-y: auto; 
        }
        .app-screen.active { display: flex; }

        /* [ë°œì‹ ] êµ¬ì¡° ìš”ì²­ ëª¨ë“œ */
        #senderScreen { justify-content: center; padding: 20px; }
        .radar-box { position: relative; width: 280px; height: 280px; display: flex; align-items: center; justify-content: center; margin-bottom: 30px; }
        .outer-glow {
            position: absolute; width: 100%; height: 100%; border-radius: 50%; padding: 8px;
            background: conic-gradient(from 0deg, #ff0000, #ff7f00, #ffff00, #00ff00, #00ffff, #0000ff, #8b00ff, #ff0000);
            -webkit-mask: radial-gradient(farthest-side, transparent calc(100% - 8px), #fff calc(100% - 7px));
            animation: rotate 4s linear infinite;
            filter: drop-shadow(0 0 12px rgba(255, 255, 255, 0.4));
        }
        @keyframes rotate { 100% { transform: rotate(360deg); } }

        .inner-circle {
            width: 235px; height: 235px; background: #111827; border-radius: 50%;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            box-shadow: inset 0 0 30px rgba(0,0,0,0.8); border: 1px solid rgba(255,255,255,0.1);
            cursor: pointer; z-index: 10;
        }
        .sos-main { font-size: 64px; font-weight: 900; }
        .sos-sub { font-size: 20px; color: #94a3b8; margin-top: 5px; }

        .tracking-badge {
            background: rgba(220, 38, 38, 0.15); color: #ff4d4d; padding: 12px 30px; border-radius: 50px; border: 2px solid #ef4444;
            font-size: 18px; font-weight: 800; margin-top: 30px; box-shadow: 0 0 15px rgba(239, 68, 68, 0.5);
            animation: blink 1.5s infinite;
        }
        @keyframes blink { 50% { opacity: 0.4; } }

        /* [ìˆ˜ì‹ ] ê°€ì¡± ë³´í˜¸ ëª¨ë“œ */
        #receiverScreen { background: #064e3b; padding: 20px; }
        #receiverScreen.emergency { background: #991b1b !important; animation: blink-bg 0.5s infinite alternate; }
        @keyframes blink-bg { from { opacity: 1; } to { opacity: 0.8; } }
        
        .receiver-title { font-size: 28px; margin: 20px 0; font-weight: 900; text-align: center; }
        #map { width: 100%; height: 320px; border-radius: 20px; border: 3px solid rgba(255,255,255,0.2); margin-bottom: 20px; }
        .status-card { background: rgba(255,255,255,0.1); padding: 20px; border-radius: 20px; text-align: center; border: 1px solid rgba(255,255,255,0.2); width: 100%; }

        /* [ê³µí†µ ë²„íŠ¼] */
        .btn-action { width: 100%; padding: 18px; border-radius: 15px; border: none; font-weight: 900; font-size: 18px; cursor: pointer; margin-top: 10px; }
        .btn-red { background: #dc2626; color: white; }
        .btn-green { background: #10b981; color: white; }

        /* ========== ì„¤ì • ë ˆì´ì–´ ========== */
        .settings-overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #0f172a; z-index: 10000; padding: 85px 20px 20px;
        }
        .settings-overlay.active { display: block; }
        .card { background: #1e293b; padding: 20px; border-radius: 20px; border: 1px solid #334155; margin-bottom: 20px; }
        .id-display { background: rgba(59, 130, 246, 0.2); padding: 15px; border-radius: 15px; text-align: center; border: 2px solid #3b82f6; margin-top: 10px; }
        .id-text { font-size: 32px; color: #60a5fa; font-weight: 900; }
    </style>
</head>
<body>

    <header class="top-header">
        <div class="icon-btn" onclick="window.toggleMode()">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5"><path d="M7 16l-4-4 4-4M3 12h18M17 8l4 4-4 4"/></svg>
        </div>
        <div class="header-title" id="headerTitle">êµ¬ì¡° ìš”ì²­ ëª¨ë“œ</div>
        <div class="icon-btn" onclick="window.showSettings()">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0a2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>
        </div>
    </header>

    <main id="senderScreen" class="app-screen active">
        <div class="radar-box">
            <div class="outer-glow"></div>
            <div class="inner-circle" id="sosBtn">
                <div class="sos-main">SOS</div>
                <div class="sos-sub">êµ¬ì¡°ìš”ì²­</div>
            </div>
        </div>
        <div id="statusMsg"></div> <div id="trackingBadge" class="tracking-badge" style="display:none;">ğŸ“ ì‹¤ì‹œê°„ ìœ„ì¹˜ ì¶”ì  ì¤‘</div>
    </main>

    <main id="receiverScreen" class="app-screen">
        <h1 class="receiver-title">ê°€ì¡± ë³´í˜¸ ì„¼í„°</h1>
        <div id="map"></div>
        <div class="status-card">
            <p id="recvStatus" style="font-size: 18px;">ê°€ì¡±ì˜ ì‹ í˜¸ë¥¼ ê¸°ë‹¤ë¦¬ëŠ” ì¤‘...</p>
        </div>
        <button class="btn-action btn-white" id="soundBtn">ğŸ”Š ì‚¬ì´ë Œ ì¤€ë¹„</button>
        <button class="btn-action btn-red" id="stopSiren" style="display:none;">ì‚¬ì´ë Œ ì •ì§€</button>
    </main>

    <div id="settingsOverlay" class="settings-overlay">
        <div class="card">
            <h3 style="margin-bottom:10px;">ë‚´ ê¸°ê¸° ê³ ìœ  ID</h3>
            <div class="id-display"><span class="id-text" id="myIdText">SZ-XXXX</span></div>
        </div>
        <div class="card">
            <h3>ğŸ‘¥ ì—°ê²° ê´€ë¦¬</h3>
            <p style="font-size:14px; opacity:0.7; margin:10px 0;">ìƒëŒ€ì˜ IDë¥¼ ì…ë ¥í•˜ì—¬ ì—°ê²°í•˜ì„¸ìš”.</p>
            <input type="text" id="friendInput" class="input-box" placeholder="ì˜ˆ: SZ-A1B2">
            <button class="btn-add" onclick="window.addFriend()">ì—°ê²° ì¶”ê°€í•˜ê¸°</button>
        </div>
        <button class="btn-action btn-white" onclick="window.hideSettings()">ë‹«ê¸°</button>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
        import { getDatabase, ref, set, remove, onValue, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCJnlwuftFUmmazQg-riYRewSeKRjBB8g",
            databaseURL: "https://safezone-2c1b2-default-rtdb.firebaseio.com",
            projectId: "safezone-2c1b2",
            appId: "1:181205095456:web:da0a519ff43cc19e7b1845"
        };
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const geocoder = new kakao.maps.services.Geocoder();

        let myID = localStorage.getItem('safeZoneID_V19') || 'SZ-' + Math.random().toString(36).substr(2, 4).toUpperCase();
        localStorage.setItem('safeZoneID_V19', myID);
        document.getElementById('myIdText').innerText = myID;

        let currentMode = 'sender';
        let isTracking = false;
        let watchId = null;

        // [ìˆ˜ì • í•µì‹¬] ëª¨ë“  ê¸°ëŠ¥ì„ window ê°ì²´ì— ì—°ê²°í•˜ì—¬ í´ë¦­ ì‘ë™ ë³´ì¥
        window.toggleMode = function() {
            currentMode = (currentMode === 'sender') ? 'receiver' : 'sender';
            document.getElementById('headerTitle').innerText = (currentMode === 'sender') ? 'êµ¬ì¡° ìš”ì²­ ëª¨ë“œ' : 'ê°€ì¡± ë³´í˜¸ ëª¨ë“œ';
            document.getElementById('senderScreen').classList.toggle('active');
            document.getElementById('receiverScreen').classList.toggle('active');
            if (currentMode === 'receiver') {
                setTimeout(() => { map.relayout(); startListening(); }, 300);
            }
        };

        window.showSettings = () => document.getElementById('settingsOverlay').classList.add('active');
        window.hideSettings = () => document.getElementById('settingsOverlay').classList.remove('active');

        // ë°œì‹  ë²„íŠ¼
        document.getElementById('sosBtn').onclick = function() {
            if(!isTracking) {
                isTracking = true;
                this.parentElement.classList.add('tracking');
                document.getElementById('trackingBadge').style.display = 'block';
                if(navigator.vibrate) navigator.vibrate([200, 100, 200]);

                watchId = navigator.geolocation.watchPosition(pos => {
                    const lat = pos.coords.latitude, lon = pos.coords.longitude;
                    geocoder.coord2Address(lon, lat, (res, status) => {
                        let addr = (status === kakao.maps.services.Status.OK) ? res[0].address.address_name : 'ìœ„ì¹˜ í™•ì¸ ì¤‘';
                        set(ref(db, 'emergency_global'), { sender: myID, lat, lon, address: addr, time: new Date().toLocaleTimeString() });
                    });
                });
            } else {
                isTracking = false;
                navigator.geolocation.clearWatch(watchId);
                remove(ref(db, 'emergency_global'));
                this.parentElement.classList.remove('tracking');
                document.getElementById('trackingBadge').style.display = 'none';
                document.getElementById('statusMsg').innerText = "";
            }
        };

        // ìˆ˜ì‹  ë° ì§€ë„
        const map = new kakao.maps.Map(document.getElementById('map'), { center: new kakao.maps.LatLng(37.5665, 126.9780), level: 3 });
        const marker = new kakao.maps.Marker({ position: map.getCenter() });
        marker.setMap(map);
        window.kakaoMap = map;

        const siren = new Audio('https://actions.google.com/sounds/v1/alarms/siren_wailing.ogg');
        siren.loop = true;
        let sirenReady = false;

        document.getElementById('soundBtn').onclick = function() {
            siren.play().then(() => { siren.pause(); sirenReady = true; this.innerText = "âœ… ì‚¬ì´ë Œ ê°ì‹œ ì¤‘"; this.style.background = "#10b981"; });
        };

        function startListening() {
            onValue(ref(db, 'emergency_global'), (snap) => {
                const data = snap.val();
                if(data) {
                    const pos = new kakao.maps.LatLng(data.lat, data.lon);
                    map.setCenter(pos); marker.setPosition(pos);
                    document.getElementById('recvStatus').innerHTML = `ğŸš¨ <strong>${data.sender}</strong>ë‹˜ êµ¬ì¡° ìš”ì²­!<br>ì‹œê°„: ${data.time}`;
                    if(sirenReady) siren.play();
                    document.getElementById('receiverScreen').classList.add('emergency');
                    document.getElementById('stopSiren').style.display = "block";
                } else {
                    hideEmergency();
                }
            });
        }

        function hideEmergency() {
            siren.pause();
            document.getElementById('receiverScreen').classList.remove('emergency');
            document.getElementById('receiverTitle').innerText = "ê°€ì¡± ë³´í˜¸ ì„¼í„°";
            document.getElementById('recvStatus').innerText = "ê°€ì¡±ì˜ ì‹ í˜¸ë¥¼ ê¸°ë‹¤ë¦¬ëŠ” ì¤‘...";
            document.getElementById('stopSiren').style.display = "none";
        }

        document.getElementById('stopSiren').onclick = () => { siren.pause(); siren.currentTime = 0; };
    </script>
</body>
</html>
