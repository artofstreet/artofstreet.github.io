<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>ì•ˆì „ì§€ëŒ€ V5.5</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: sans-serif; -webkit-tap-highlight-color: transparent; user-select: none; }
        body { background: linear-gradient(135deg, #1e3c72 0%, #2a5298 50%, #7e22ce 100%); color: white; height: 100vh; overflow: hidden; font-weight: 900; }
        .screen { display: none; height: 100vh; width: 100%; flex-direction: column; align-items: center; justify-content: center; padding: 20px; text-align: center; position: absolute; }
        .active { display: flex; }
        
        /* ë©”ì¸ ë²„íŠ¼ UI */
        .btn-wrap { position: relative; width: 350px; height: 350px; display: flex; align-items: center; justify-content: center; }
        .emergency-btn { width: 280px; height: 280px; border-radius: 50%; background: linear-gradient(135deg, #ff0844 0%, #ff4757 100%); border: none; color: white; font-size: 56px; cursor: pointer; z-index: 10; box-shadow: 0 20px 60px rgba(255, 8, 68, 0.4); }
        .ring { position: absolute; border-radius: 50%; border: 8px solid transparent; }
        .ring1 { width: 330px; height: 330px; border-top-color: rgba(255, 215, 0, 0.8); animation: rot 3s linear infinite; }
        .ring2 { width: 350px; height: 350px; border-bottom-color: rgba(255, 255, 255, 0.4); animation: rot-rev 4s linear infinite; }
        @keyframes rot { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        @keyframes rot-rev { from { transform: rotate(360deg); } to { transform: rotate(0deg); } }
        
        /* ì„¤ì • í™”ë©´ UI */
        .gear { position: absolute; top: 30px; right: 30px; font-size: 40px; cursor: pointer; background: rgba(255,255,255,0.1); padding: 10px; border-radius: 50%; z-index: 20; border: 1px solid rgba(255,255,255,0.2); }
        .card { background: rgba(255,255,255,0.1); padding: 25px; border-radius: 24px; width: 100%; margin-bottom: 15px; backdrop-filter: blur(15px); border: 1px solid rgba(255,255,255,0.2); text-align: left; }
        .id-val { font-size: 42px; color: #ffd700; margin: 10px 0; font-family: monospace; text-align: center; letter-spacing: 2px; }
        .input-box { width: 100%; padding: 15px; border-radius: 12px; border: none; font-size: 18px; margin-top: 10px; margin-bottom: 10px; text-align: center; font-weight: bold; color: #333; }
        .btn-ui { width: 100%; padding: 20px; font-size: 22px; border-radius: 15px; border: none; cursor: pointer; margin-top: 5px; font-weight: 800; }
        .btn-add { background: #ffd700; color: #1e3c72; }
        .btn-back { background: rgba(255,255,255,0.2); color: white; margin-top: 20px; }
        
        /* ì¹œêµ¬ ëª©ë¡ ì•„ì´í…œ ìŠ¤íƒ€ì¼ */
        .friend-item { display: flex; justify-content: space-between; align-items: center; background: rgba(0,0,0,0.2); padding: 15px; border-radius: 12px; margin-bottom: 8px; font-size: 20px; }
        .btn-del { background: transparent; border: none; color: #ff4757; font-size: 22px; cursor: pointer; }

        /* ë¸”ë™ì•„ì›ƒ ëª¨ë“œ */
        #blackout { background: #000; z-index: 1000; }
    </style>
</head>
<body oncontextmenu="return false;">

    <div id="mainScreen" class="screen active">
        <div class="gear" onclick="go('setScreen')">âš™ï¸</div>
        <div class="btn-wrap">
            <div class="ring ring1"></div><div class="ring ring2"></div>
           <button class="emergency-btn" id="sosBtn">ê¸´ê¸‰êµ¬ì¡°</button>
        </div>
    </div>

    <div id="setScreen" class="screen" style="justify-content: flex-start; overflow-y: auto;">
        <h1 style="margin: 40px 0 20px;">ì„¤ì •</h1>
        
        <div class="card" style="text-align: center;">
            <p style="opacity: 0.8; font-size: 20px;">ë‚´ ì•ˆì „ ID</p>
            <div id="myID" class="id-val">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
        </div>
        
        <div class="card">
            <p style="font-size: 22px; margin-bottom: 10px;">ğŸ¤ ì¹œêµ¬ ë“±ë¡í•˜ê¸°</p>
            <input type="text" id="friendID" class="input-box" placeholder="ì˜ˆ: SZ-A1B2">
            <button class="btn-ui btn-add" onclick="addFriend()">ì´ IDë¥¼ ì¹œêµ¬ë¡œ ì¶”ê°€</button>
        </div>

        <div class="card">
            <p style="opacity: 0.8; margin-bottom: 15px; font-size: 20px;">ì—°ê²°ëœ ì¹œêµ¬ ëª©ë¡</p>
            <div id="friendList" style="color: #ffd700;">ë“±ë¡ëœ ì¹œêµ¬ê°€ ì—†ìŠµë‹ˆë‹¤.</div>
        </div>

        <div class="card" style="display: flex; justify-content: space-between; align-items: center;">
            <span style="font-size: 24px;">ğŸ”Š ì†Œë¦¬ ì¼œê¸° (ì•ˆì‹¬ëª¨ë“œ)</span>
            <input type="checkbox" id="snd" checked style="width: 35px; height: 35px;">
        </div>

        <button class="btn-ui btn-back" onclick="go('mainScreen')">ëŒì•„ê°€ê¸°</button>
    </div>

    <div id="blackout" class="screen" onclick="handleTap()">
        <div style="color:rgba(255,255,255,0.05)">3ë²ˆ íƒ­í•˜ë©´ í•´ì œ</div>
    </div>

    <script>
        function go(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }

        function initID() {
            let savedID = localStorage.getItem('safeZoneID');
            if (!savedID) {
                savedID = 'SZ-' + Math.random().toString(36).substr(2, 4).toUpperCase();
                localStorage.setItem('safeZoneID', savedID);
            }
            document.getElementById('myID').innerText = savedID;
            loadFriends();
        }

        function addFriend() {
            const idInput = document.getElementById('friendID');
            const newFriendID = idInput.value.trim().toUpperCase();
            
            if (newFriendID.length < 5 || !newFriendID.startsWith('SZ-')) { 
                alert("ì˜¬ë°”ë¥¸ ID í˜•ì‹ì´ ì•„ë‹™ë‹ˆë‹¤. (ì˜ˆ: SZ-XXXX)"); return; 
            }
            
            let friends = JSON.parse(localStorage.getItem('myFriends') || "[]");
            if (!friends.includes(newFriendID)) {
                friends.push(newFriendID);
                localStorage.setItem('myFriends', JSON.stringify(friends));
                idInput.value = ""; 
                loadFriends(); 
            } else { alert("ì´ë¯¸ ë“±ë¡ëœ ì¹œêµ¬ì…ë‹ˆë‹¤."); }
        }

        function removeFriend(idToRemove) {
            if(confirm(idToRemove + " ë‹˜ì„ ì¹œêµ¬ ëª©ë¡ì—ì„œ ì§€ìš°ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                let friends = JSON.parse(localStorage.getItem('myFriends') || "[]");
                friends = friends.filter(f => f !== idToRemove);
                localStorage.setItem('myFriends', JSON.stringify(friends));
                loadFriends();
            }
        }

        function loadFriends() {
            let friends = JSON.parse(localStorage.getItem('myFriends') || "[]");
            const listDiv = document.getElementById('friendList');
            if (friends.length > 0) {
                listDiv.innerHTML = friends.map(f => 
                    `<div class="friend-item">
                        <span>âœ… ${f}</span>
                        <button class="btn-del" onclick="removeFriend('${f}')">âŒ</button>
                    </div>`
                ).join('');
            } else {
                listDiv.innerHTML = "ë“±ë¡ëœ ì¹œêµ¬ê°€ ì—†ìŠµë‹ˆë‹¤.";
            }
        }

        initID();

        let timer, isHolding = false;
        const btn = document.getElementById('sosBtn');
        
        btn.onpointerdown = (e) => {
            e.preventDefault();
            if (isHolding) return;
            isHolding = true;
            navigator.vibrate(100); 
            
           timer = setTimeout(() => {
            navigator.vibrate([200, 100, 200, 100, 200]);
            
            if (typeof window.sendSOS === 'function') {
                window.sendSOS(); 
            }

            if(document.getElementById('snd').checked) {
                const ut = new SpeechSynthesisUtterance('êµ¬ì¡° ì‹ í˜¸ê°€ ì „ì†¡ë˜ì—ˆìŠµë‹ˆë‹¤');
                ut.lang = 'ko-KR'; 
                window.speechSynthesis.speak(ut);
            } else { 
                go('blackout'); 
            }
            isHolding = false;
        }, 2000);
        };
        
        btn.onpointerup = btn.onpointerleave = () => { clearTimeout(timer); isHolding = false; };

        let tapCount = 0, tapTimer;
        function handleTap() {
            tapCount++; clearTimeout(tapTimer);
            tapTimer = setTimeout(() => { tapCount = 0; }, 1000);
            if(tapCount >= 3) { go('mainScreen'); tapCount = 0; }
        }
    </script>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-analytics.js";
        import { getDatabase, ref, set } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCJnlwuftFUmmazQg-riYRewSeKRjBB8g", 
            authDomain: "safezone-2c1b2.firebaseapp.com",
            databaseURL: "https://safezone-2c1b2-default-rtdb.firebaseio.com",
            projectId: "safezone-2c1b2",
            storageBucket: "safezone-2c1b2.firebasestorage.app",
            messagingSenderId: "181205095456",
            appId: "1:181205095456:web:da0a519ff43cc19e7b1845",
            measurementId: "G-X6QBMSL7DS"
        };

        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);
        const database = getDatabase(app);

        // ë²„íŠ¼ì„ ëˆŒë €ì„ ë•Œ ì‹¤í–‰ë  ë§ˆë²•ì˜ í•¨ìˆ˜! (ì¹´ì¹´ì˜¤ API ì§€ë²ˆ ë³€í™˜ ì ìš© ì™„ë£Œ)
        window.sendSOS = function() {
            const now = new Date().toLocaleString(); 
            
            // â­ ì£¼ì˜: ì—¬ê¸°ì— ë°œê¸‰ë°›ìœ¼ì‹  ì¹´ì¹´ì˜¤ REST API í‚¤ë¥¼ ë„£ìœ¼ì…”ì•¼ í•©ë‹ˆë‹¤! â­
            const KAKAO_API_KEY = "ì—¬ê¸°ì—_ì¹´ì¹´ì˜¤_REST_API_í‚¤ë¥¼_ë„£ìœ¼ì„¸ìš”";

            if ("geolocation" in navigator) {
                navigator.geolocation.getCurrentPosition(async (position) => {
                    const lat = position.coords.latitude;
                    const lon = position.coords.longitude;
                    
                    const mapUrl = `https://map.kakao.com/link/map/ê¸´ê¸‰êµ¬ì¡°ìœ„ì¹˜,${lat},${lon}`;
                    let exactAddress = "ìœ„ì¹˜ í™•ì¸ ì¤‘...";

                    try {
                        const response = await fetch(`https://dapi.kakao.com/v2/local/geo/coord2address.json?x=${lon}&y=${lat}`, {
                            headers: { "Authorization": `KakaoAK ${KAKAO_API_KEY}` }
                        });
                        const data = await response.json();
                        
                        if (data.documents && data.documents.length > 0) {
                            const addressData = data.documents[0];
                            const roadAddr = addressData.road_address ? addressData.road_address.address_name : "";
                            const jibunAddr = addressData.address ? addressData.address.address_name : "";
                            exactAddress = roadAddr ? `[ì§€ë²ˆ] ${jibunAddr} / [ë„ë¡œëª…] ${roadAddr}` : `[ì§€ë²ˆ] ${jibunAddr}`;
                        } else {
                            exactAddress = "ìƒì„¸ ì£¼ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ëŠ” ì§€ì—­ì…ë‹ˆë‹¤.";
                        }
                    } catch (error) {
                        console.error("ì¹´ì¹´ì˜¤ ì£¼ì†Œ ë³€í™˜ ì‹¤íŒ¨:", error);
                        exactAddress = "ì£¼ì†Œ ë³€í™˜ ì‹¤íŒ¨ (API ì—°ê²° í™•ì¸ í•„ìš”)";
                    }

                    // êµ¬ê¸€ ì„œë²„ì— í•œê¸€ ì£¼ì†Œì™€ í•¨ê»˜ 'ê¸´ê¸‰ ìƒí™©' ì•Œë¦¬ê¸°!
                    set(ref(database, 'emergency_signal'), {
                        status: "ë„ì™€ì£¼ì„¸ìš”!",
                        time: now,
                        message: "ì¥í™”ë‹˜ì´ ê¸´ê¸‰ ì‹ í˜¸ë¥¼ ë³´ëƒˆìŠµë‹ˆë‹¤!",
                        lat: lat,
                        lon: lon,
                        mapUrl: mapUrl,
                        address: exactAddress 
                    });
                    
                    alert("ğŸš¨ êµ¬ì¡° ì‹ í˜¸ì™€ ì •í™•í•œ ì§€ë²ˆ ì£¼ì†Œê°€ ë°œì†¡ë˜ì—ˆìŠµë‹ˆë‹¤!\n" + exactAddress);
                    
                }, (error) => {
                    alert("ìœ„ì¹˜ ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. í•¸ë“œí°ì˜ ìœ„ì¹˜ ê¶Œí•œì„ ì¼œì£¼ì„¸ìš”.");
                }, { enableHighAccuracy: true });
            } else {
                alert("ì´ ê¸°ê¸°ì—ì„œëŠ” ìœ„ì¹˜ ì¶”ì ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
            }
        };
    </script>
</body>
</html>
