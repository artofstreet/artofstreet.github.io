<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>ì•ˆì „ì§€ëŒ€ ë°œì‹ ì†Œ V3.0 (ì‹¤ì œ ìœ„ì¹˜)</title>

    <script type="text/javascript" src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=5d19f896badf6fdab5297f129bffaf1e&libraries=services"></script>
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: sans-serif; }
        body { height: 100vh; display: flex; flex-direction: column; align-items: center; justify-content: center; background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%); color: white; text-align: center; padding: 20px; }
        .card { background: rgba(255,255,255,0.1); padding: 25px; border-radius: 20px; width: 100%; max-width: 400px; margin-bottom: 20px; backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.2); }
        .id-text { font-size: 32px; color: #ffd700; font-weight: 900; margin: 10px 0; letter-spacing: 2px; }
        .btn-emergency { width: 100%; max-width: 350px; padding: 25px; font-size: 28px; font-weight: 900; color: white; background: #ff4757; border: none; border-radius: 50px; cursor: pointer; box-shadow: 0 10px 20px rgba(0,0,0,0.3); transition: 0.2s; }
        .btn-emergency:active { transform: scale(0.95); background: #ff0844; }
        #statusMsg { margin-top: 15px; font-size: 16px; color: #ffd700; font-weight: bold; }
    </style>
</head>
<body>

    <div class="card">
        <p style="opacity: 0.8;">ë‚˜ì˜ ë°œì‹  ID (ìˆ˜ì‹ ìì—ê²Œ ì•Œë ¤ì£¼ì„¸ìš”)</p>
        <div id="myIDDisplay" class="id-text">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
    </div>

    <button class="btn-emergency" onclick="startEmergency()">ğŸš¨ ê¸´ê¸‰ êµ¬ì¡° ìš”ì²­</button>
    <p id="statusMsg">ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ ì‹¤ì œ ìœ„ì¹˜ê°€ ì „ì†¡ë©ë‹ˆë‹¤.</p>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
        import { getDatabase, ref, set, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-database.js";

        // [ì¤‘ìš”] íŒŒì´ì–´ë² ì´ìŠ¤ ì„¤ì •ê°’ (ìŠ¤ë¥´ì‚¬ë§ˆì˜ ì„œë²„ í‚¤)
        const firebaseConfig = {
            apiKey: "AIzaSyCJnlwuftFUmmazQg-riYRewSeKRjBB8g",
            databaseURL: "https://safezone-2c1b2-default-rtdb.firebaseio.com",
            projectId: "safezone-2c1b2",
            appId: "1:181205095456:web:da0a519ff43cc19e7b1845"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // 1. ë‚´ ê³ ìœ  ID ìƒì„± (ìˆ˜ì‹ ì†Œì— ë“±ë¡í•  ë²ˆí˜¸)
        let myID = localStorage.getItem('safeZoneID_SND');
        if (!myID) {
            myID = 'SZ-' + Math.random().toString(36).substr(2, 4).toUpperCase();
            localStorage.setItem('safeZoneID_SND', myID);
        }
        document.getElementById('myIDDisplay').innerText = myID;

        const statusMsg = document.getElementById('statusMsg');

        // [í•µì‹¬ 2] ì¹´ì¹´ì˜¤ ì£¼ì†Œ ë³€í™˜ê¸° ì¤€ë¹„ (API í‚¤ê°€ ì •ìƒì´ì–´ì•¼ ì‘ë™í•©ë‹ˆë‹¤)
        const geocoder = new kakao.maps.services.Geocoder();

        window.startEmergency = function() {
            statusMsg.innerText = "ğŸ“ í˜„ì¬ ìœ„ì¹˜ë¥¼ íŒŒì•… ì¤‘ì…ë‹ˆë‹¤...";
            
            // 2. í•¸ë“œí°ì˜ GPS ì„¼ì„œ ì¼œê¸°
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(function(position) {
                    const lat = position.coords.latitude;
                    const lon = position.coords.longitude;

                    // 3. ì¹´ì¹´ì˜¤ APIë¡œ ìœ„ë„/ê²½ë„ë¥¼ ì§„ì§œ 'í•œê¸€ ì£¼ì†Œ'ë¡œ ë²ˆì—­
                    geocoder.coord2Address(lon, lat, function(result, status) {
                        if (status === kakao.maps.services.Status.OK) {
                            
                            // ë„ë¡œëª… ì£¼ì†Œê°€ ìˆìœ¼ë©´ ìš°ì„  ì‚¬ìš©, ì—†ìœ¼ë©´ ì§€ë²ˆ ì£¼ì†Œ ì‚¬ìš©
                            const address = result[0].road_address ? result[0].road_address.address_name : result[0].address.address_name;
                            const mapUrl = `https://map.kakao.com/link/map/ê¸´ê¸‰êµ¬ì¡°ìš”ì²­,${lat},${lon}`;
                            
                            // 4. ë²ˆì—­ëœ ì£¼ì†Œë¥¼ ë‚´ ì•„ì´ë”” ì „ìš© ì±„ë„ì— ì „ì†¡ [ë³´ì•ˆ ì±„ë„]
                            const myPath = ref(db, 'emergency_signals/' + myID);
                            
                            set(myPath, {
                                sender: myID,
                                address: address,
                                lat: lat,
                                lon: lon,
                                mapUrl: mapUrl,
                                time: new Date().toLocaleString(),
                                timestamp: serverTimestamp()
                            }).then(() => {
                                statusMsg.innerText = "âœ… êµ¬ì¡° ì‹ í˜¸ ì „ì†¡ ì™„ë£Œ!";
                                alert("ì‹¤ì œ ìœ„ì¹˜ê°€ ì„±ê³µì ìœ¼ë¡œ ì „ì†¡ë˜ì—ˆìŠµë‹ˆë‹¤!\n\nì£¼ì†Œ: " + address);
                            });

                        } else {
                            statusMsg.innerText = "âŒ ì£¼ì†Œ ë³€í™˜ ì‹¤íŒ¨. ì¹´ì¹´ì˜¤ API í‚¤ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.";
                        }
                    });
                }, function(error) {
                    statusMsg.innerText = "âŒ ìœ„ì¹˜ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. í•¸ë“œí°ì˜ GPS(ìœ„ì¹˜) ì„¤ì •ì´ ì¼œì ¸ ìˆëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”.";
                }, {
                    enableHighAccuracy: true, // ë°°í„°ë¦¬ë¥¼ ì¡°ê¸ˆ ë” ì“°ë”ë¼ë„ ê°€ì¥ ì •í™•í•œ ìœ„ì¹˜ë¥¼ ì¡ë„ë¡ ì„¤ì •
                    timeout: 10000,
                    maximumAge: 0
                });
            } else {
                statusMsg.innerText = "âŒ ì´ ë¸Œë¼ìš°ì €ì—ì„œëŠ” GPS ê¸°ëŠ¥ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.";
            }
        };
    </script>
</body>
</html>
