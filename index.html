<!DOCTYPE html>
<html lang="ko" style="background: #0f172a;">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#1e3a8a">
    <title>ArtOfStreet ì•ˆì „ì§€ëŒ€ V20.9</title>
    
    <link rel="manifest" href="manifest-sender.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
    <script type="text/javascript" src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=5d19f896badf6fdab5297f129bffaf1e&libraries=services"></script>
    <link href="https://fonts.googleapis.com/css2?family=Black+Han+Sans&family=Noto+Sans+KR:wght@400;700;900&display=swap" rel="stylesheet">
    
    <style>
        * { 
            margin: 0; padding: 0; box-sizing: border-box; 
            font-family: 'Noto Sans KR', -apple-system, BlinkMacSystemFont, sans-serif;
            -webkit-user-select: none; user-select: none; 
            -webkit-touch-callout: none; -webkit-tap-highlight-color: transparent; 
            outline: none !important; 
        }
        html, body { 
            width: 100%; height: 100%; overflow: hidden; 
            position: fixed; touch-action: manipulation; 
        }
        body { background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%) !important; color: white; }
        
        /* ========== ìƒë‹¨ í—¤ë” ========== */
        .top-header { 
            position: fixed; top: 0; left: 0; right: 0; height: 54px; 
            z-index: 9999; display: flex; align-items: center;
            justify-content: space-between; padding: 0 16px;
            transition: background 0.3s;
            border: none; border-bottom: none;
        }
        .top-header.support-header { background: #2ECC71; box-shadow: none; }
        .top-header.sender-header { background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%); box-shadow: none; border-bottom: none; }

        .header-icon-btn {
            width: 36px; height: 36px; display: flex; align-items: center; justify-content: center;
            cursor: pointer; border-radius: 8px; transition: background 0.2s; font-size: 20px;
        }
        .header-icon-btn:hover { background: rgba(0,0,0,0.1); }

        .header-center { display: flex; align-items: center; gap: 8px; }
        .header-title { 
            font-size: 18px; font-weight: 700; letter-spacing: 0.2px;
            transition: color 0.3s; white-space: nowrap;
        }
        .header-dot {
            width: 8px; height: 8px; border-radius: 50%;
            animation: dotPulse 1.5s ease-in-out infinite;
        }
        @keyframes dotPulse { 0%,100%{opacity:1;transform:scale(1);}50%{opacity:0.4;transform:scale(0.7);} }

        .switch-btn {
            width: 36px; height: 36px; display: flex; align-items: center; justify-content: center;
            cursor: pointer; border-radius: 8px; transition: background 0.2s;
        }
        .switch-btn:hover { background: rgba(0,0,0,0.1); }

        /* ========== ì•± í™”ë©´ ê³µí†µ ========== */
        .app-screen { 
            display: none; width: 100%; 
            height: calc(100% - 54px);
            position: absolute; top: 54px; left: 0; overflow: hidden;
        }
        .app-screen.active { display: flex; }

        /* ========== ë°œì‹  í™”ë©´ (êµ¬ì¡° ìš”ì²­ ëª¨ë“œ) ========== */
        #senderScreen { 
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            flex-direction: column; align-items: center; justify-content: center; padding: 20px; 
        }
        
        .radar-container-sender { 
            position: relative; width: 280px; height: 280px; 
            display: flex; align-items: center; justify-content: center; margin: 30px 0;
        }
        
        .radar-ring {
            position: absolute; width: 100%; height: 100%; border-radius: 50%;
            pointer-events: none; animation: spin-ring 1.5s linear infinite;
        }
        .radar-ring::before {
            content: ''; position: absolute; top: -2px; left: -2px; right: -2px; bottom: -2px;
            border-radius: 50%;
            background: conic-gradient(
                from 0deg, transparent 0deg, transparent 90deg,
                #FF00FF 90deg, #FF00FF 180deg,
                #FF0000 180deg, #FF0000 270deg,
                #FFFF00 270deg, #FFFF00 360deg
            );
        }
        .radar-ring::after {
            content: ''; position: absolute; top: 3px; left: 3px; right: 3px; bottom: 3px;
            background: #0f172a; border-radius: 50%;
        }
        @keyframes spin-ring { 0%{transform:rotate(0deg);}100%{transform:rotate(360deg);} }
        
        .btn-emergency { 
            width: 255px; height: 255px;
            background: radial-gradient(circle, #FF4444 0%, #FF0000 100%); 
            border-radius: 50%; border: none; color: white; 
            box-shadow: 0 0 30px rgba(255,0,0,0.6); 
            cursor: pointer; z-index: 10; transition: all 0.2s; touch-action: manipulation;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            padding: 0; position: relative;
        }
        .btn-emergency:active { transform: scale(0.95); box-shadow: 0 0 50px rgba(255,0,0,0.9); }
        .btn-emergency.tracking { animation: pulse-button 1.5s ease-in-out infinite; }
        @keyframes pulse-button { 
            0%,100%{transform:scale(1);box-shadow:0 0 20px rgba(255,0,0,0.5);} 
            50%{transform:scale(1.05);box-shadow:0 0 60px rgba(255,0,0,0.9);} 
        }
        
        .sos-text { font-family: 'Black Han Sans', sans-serif; font-size: 64px; font-weight: 400; color: white; letter-spacing: 6px; text-shadow: 0 3px 12px rgba(0,0,0,0.4); line-height: 1; }
        .request-text { font-size:22px; font-weight:700; color:rgba(255,255,255,0.95); letter-spacing:1px; margin-top:8px; }
        
        #statusMsg { margin-top: 20px; font-size: 20px; color: #60a5fa; font-weight: 600; text-align: center; }
        .tracking-badge { 
            background: rgba(255,51,51,0.9); padding: 10px 24px; border-radius: 25px; 
            font-size: 18px; margin-top: 16px; display: inline-block; 
            animation: blink 1s infinite; border: 2px solid rgba(255,255,255,0.3);
        }
        @keyframes blink { 0%,100%{opacity:1;}50%{opacity:0.5;} }

        /* ========== ì§€ì› í™”ë©´ (SOS ì§€ì› ëª¨ë“œ) ========== */
        #receiverScreen {
            background: #2ECC71;
            flex-direction: column; align-items: center; justify-content: center;
            gap: 28px; padding: 20px;
            transition: background 0.15s;
        }
        #receiverScreen.alerting { animation: flashBg 0.6s ease-in-out infinite; }
        @keyframes flashBg { 0%,100%{background:#2ECC71;}50%{background:#FF3E8B;} }

        /* ë ˆì´ë” */
        .radar-wrap { width:230px; height:230px; display:flex; align-items:center; justify-content:center; position:relative; margin-top: -30px; }
        .radar-base {
            width:210px; height:210px; border-radius:50%;
            background:radial-gradient(circle, rgba(0,50,20,0.85) 0%, rgba(0,25,10,0.95) 100%);
            border:2px solid rgba(0,255,100,0.35); position:relative; overflow:hidden;
            box-shadow:0 0 30px rgba(0,255,100,0.25), inset 0 0 30px rgba(0,0,0,0.5);
        }
        .radar-ring-sup {
            position:absolute; top:50%; left:50%; transform:translate(-50%,-50%);
            border-radius:50%; border:1px solid rgba(0,255,100,0.2);
        }
        .sr1{width:44px;height:44px;} .sr2{width:88px;height:88px;}
        .sr3{width:132px;height:132px;} .sr4{width:176px;height:176px;}
        .radar-cross-h{position:absolute;top:50%;left:0;right:0;height:1px;background:rgba(0,255,100,0.18);transform:translateY(-50%);}
        .radar-cross-v{position:absolute;left:50%;top:0;bottom:0;width:1px;background:rgba(0,255,100,0.18);transform:translateX(-50%);}
        .radar-sweep-wrap{position:absolute;top:0;left:0;right:0;bottom:0;animation:sweepRotate 2.5s linear infinite;transform-origin:center;}
        @keyframes sweepRotate{from{transform:rotate(0deg);}to{transform:rotate(360deg);}}
        .radar-sweep-fan{position:absolute;top:0;left:0;right:0;bottom:0;border-radius:50%;background:conic-gradient(from 270deg,rgba(0,255,100,0) 0deg,rgba(0,255,100,0.55) 55deg,rgba(0,255,100,0) 70deg);}
        .radar-center-dot{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:7px;height:7px;background:#00FF7F;border-radius:50%;box-shadow:0 0 10px #00FF7F;z-index:5;}
        .blip{position:absolute;width:5px;height:5px;background:#00FF7F;border-radius:50%;box-shadow:0 0 7px #00FF7F;animation:blipFade 2.5s ease-out infinite;}
        .sb1{top:40px;left:115px;animation-delay:0.9s;} .sb2{top:75px;left:52px;animation-delay:1.7s;} .sb3{top:122px;left:128px;animation-delay:0.4s;}
        @keyframes blipFade{0%{opacity:0;transform:scale(0.5);}20%{opacity:1;transform:scale(1.6);}60%{opacity:0.5;transform:scale(1);}100%{opacity:0;}}

        /* ì†Œë¦¬/ì§„ë™ í† ê¸€ */
        .mode-toggle{background:rgba(0,0,0,0.15);border-radius:50px;display:flex;padding:4px;gap:4px;border:1px solid rgba(255,255,255,0.2);}
        .mode-btn{padding:10px 22px;border-radius:40px;border:none;cursor:pointer;display:flex;align-items:center;gap:8px;font-family:'Noto Sans KR',sans-serif;font-size:16px;font-weight:700;transition:all 0.25s;color:rgba(255,255,255,0.55);background:transparent;}
        .mode-btn.active{background:#1A6B3C;color:#fff;box-shadow:0 3px 12px rgba(0,0,0,0.25);}

        /* ê²½ë³´ ë²„íŠ¼ */
        .sup-alert-btn{background:rgba(255,255,255,0.15);border:1.5px solid rgba(255,255,255,0.4);color:white;font-family:'Noto Sans KR',sans-serif;font-size:17px;font-weight:700;padding:13px 38px;border-radius:30px;cursor:pointer;letter-spacing:0.5px;transition:all 0.2s;}
        .sup-alert-btn:hover{background:rgba(255,255,255,0.25);}
        .sup-alert-btn:active{transform:scale(0.96);}

        /* ========== ê²½ë³´ ì˜¤ë²„ë ˆì´ (ì§€ì›ëª¨ë“œ) ========== */
        .support-alert-overlay {
            position:absolute; inset:0; display:flex; flex-direction:column;
            background:rgba(200,20,60,0.97); z-index:50;
            opacity:0; pointer-events:none; transition:opacity 0.3s; overflow-y:auto;
        }
        .support-alert-overlay.visible{opacity:1;pointer-events:all;}

        .sal-top-bar{background:rgba(0,0,0,0.3);padding:12px 16px;display:flex;align-items:center;gap:10px;flex-shrink:0;}
        .sal-siren{font-size:20px;animation:sPulse 0.6s ease-in-out infinite;}
        @keyframes sPulse{0%,100%{transform:scale(1);}50%{transform:scale(1.15);}}
        .sal-title{font-family:'Black Han Sans',sans-serif;font-size:17px;color:white;flex:1;letter-spacing:1px;}
        .sal-confirm{background:rgba(255,255,255,0.2);border:none;color:white;font-size:13px;font-weight:700;padding:7px 16px;border-radius:20px;cursor:pointer;font-family:'Noto Sans KR',sans-serif;}
        .sal-body{padding:12px 14px;display:flex;flex-direction:column;gap:10px;}
        .sal-flash{font-family:'Black Han Sans',sans-serif;font-size:19px;color:white;text-align:center;animation:sPulse 0.6s ease-in-out infinite;}
        .loc-card{background:rgba(0,0,0,0.22);border-radius:14px;padding:12px 14px;border:1px solid rgba(255,255,255,0.12);display:flex;flex-direction:column;gap:5px;}
        .loc-lbl{font-size:11px;font-weight:700;color:rgba(255,255,255,0.55);letter-spacing:1px;}
        .loc-addr{font-size:13px;font-weight:700;color:white;line-height:1.5;}
        .loc-coords{font-size:11px;color:rgba(255,255,255,0.55);font-family:monospace;}
        .loc-time{font-size:11px;color:rgba(255,255,255,0.45);text-align:right;}
        .map-box{width:100%;height:190px;border-radius:14px;overflow:hidden;border:2px solid rgba(255,255,255,0.18);}
        .map-box iframe{width:100%;height:100%;border:none;}

        /* ========== ì„¤ì • í™”ë©´ ========== */
        .settings-screen { display:none; position:absolute; top:54px; left:0; width:100%; height:calc(100% - 54px); padding:20px; overflow-y:auto; z-index:8888; }
        .settings-screen.active { display:block; }
        .settings-screen.sender-settings { background:linear-gradient(135deg,#0f172a 0%,#1e293b 100%); }
        .settings-screen.receiver-settings { background:#2ECC71; }

        .card { background:rgba(255,255,255,0.1); padding:22px; border-radius:20px; width:100%; max-width:450px; margin:0 auto 20px; border:2px solid rgba(255,255,255,0.2); backdrop-filter:blur(10px); }
        .section-title { font-size:22px; margin-bottom:12px; font-weight:bold; }
        .id-display { background:rgba(0,0,0,0.2); padding:16px; border-radius:15px; margin:12px 0; text-align:center; border:2px solid rgba(255,255,255,0.3); }
        .id-text { font-size:34px; color:#FFFFFF; font-weight:900; letter-spacing:4px; text-shadow: 0 2px 8px rgba(0,0,0,0.4); }
        .input-box { width:100%; padding:16px; border-radius:12px; border:2px solid rgba(255,255,255,0.3); font-size:22px; margin:12px 0; text-align:center; background:rgba(255,255,255,0.1); color:white; }
        .btn-add { background:#1A5C34; color:white; padding:16px; width:100%; font-size:22px; font-weight:bold; border-radius:12px; border:none; cursor:pointer; transition:all 0.2s; box-shadow:0 4px 15px rgba(0,0,0,0.25); }
        .btn-add:active { transform:scale(0.96); }
        .friend-item { background:rgba(255,255,255,0.2); padding:16px 20px; border-radius:15px; margin:10px 0; display:flex; justify-content:space-between; align-items:center; font-size:20px; font-weight:bold; border:2px solid rgba(255,255,255,0.2); }
        .btn-delete { background:#dc2626; color:white; border:none; padding:8px 18px; border-radius:25px; cursor:pointer; font-size:18px; font-weight:bold; transition:all 0.2s; }
        .btn-delete:active { transform:scale(0.88); }
        .btn-back { background:rgba(255,255,255,0.2); color:white; padding:16px; width:100%; max-width:450px; font-size:20px; font-weight:bold; border-radius:12px; border:2px solid rgba(255,255,255,0.3); cursor:pointer; transition:all 0.2s; margin:16px auto; display:block; }
        .btn-back:active { transform:scale(0.96); }
    </style>
</head>
<body>

    <!-- ========== í—¤ë” ========== -->
    <div class="top-header sender-header" id="topHeader">
        <div class="header-icon-btn" id="settingIconBtn" onclick="showSettings()">âš™ï¸</div>
        <div class="header-center">
            <span class="header-title" id="headerTitle" style="color:white;">SOS ìš”ì²­ ëª¨ë“œ</span>
            <div class="header-dot" id="headerDot" style="background:#00FF7F;box-shadow:0 0 6px #00FF7F;display:none;"></div>
        </div>
        <div class="switch-btn" id="switchBtn" onclick="toggleMode()">
            <svg width="22" height="22" viewBox="0 0 24 24" fill="none">
                <path id="swPath1" d="M7 16H20M20 16L17 13M20 16L17 19" stroke="rgba(255,255,255,0.9)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                <path id="swPath2" d="M17 8H4M4 8L7 5M4 8L7 11" stroke="rgba(255,255,255,0.9)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
        </div>
    </div>

    <!-- ========== ë°œì‹  í™”ë©´ (êµ¬ì¡° ìš”ì²­ ëª¨ë“œ) ========== -->
    <div id="senderScreen" class="app-screen active">
        <div class="radar-container-sender">
            <div class="radar-ring"></div>
            <button id="emergencyBtn" class="btn-emergency">
                <div class="sos-text">SOS</div>
                <div class="request-text">êµ¬ì¡°ìš”ì²­</div>
            </button>
        </div>
        <p id="statusMsg">ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”</p>
        <div id="trackingBadge" class="tracking-badge" style="display:none;">ğŸ“ ì‹¤ì‹œê°„ ìœ„ì¹˜ ì¶”ì  ì¤‘...</div>
    </div>

    <!-- ========== ì§€ì› í™”ë©´ (SOS ì§€ì› ëª¨ë“œ) ========== -->
    <div id="receiverScreen" class="app-screen">

        <!-- ë ˆì´ë” -->
        <div class="radar-wrap">
            <div class="radar-base">
                <div class="radar-ring-sup sr1"></div>
                <div class="radar-ring-sup sr2"></div>
                <div class="radar-ring-sup sr3"></div>
                <div class="radar-ring-sup sr4"></div>
                <div class="radar-cross-h"></div>
                <div class="radar-cross-v"></div>
                <div class="radar-sweep-wrap"><div class="radar-sweep-fan"></div></div>
                <div class="radar-center-dot"></div>
                <div class="blip sb1"></div>
                <div class="blip sb2"></div>
                <div class="blip sb3"></div>
            </div>
        </div>

        <!-- ì†Œë¦¬/ì§„ë™ í† ê¸€ -->
        <div class="mode-toggle">
            <button class="mode-btn active" id="supSoundBtn" onclick="setSupMode('sound')">
                <svg width="15" height="15" viewBox="0 0 24 24" fill="none">
                    <path d="M5 9H9L15 4V20L9 15H5V9Z" fill="currentColor"/>
                    <path d="M18 9C19.5 10.5 20 12 20 12C20 12 19.5 13.5 18 15" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                </svg>
                ì†Œë¦¬ ì¼œê¸°
            </button>
            <button class="mode-btn" id="supVibrateBtn" onclick="setSupMode('vibrate')">
                <svg width="15" height="15" viewBox="0 0 24 24" fill="none">
                    <rect x="2" y="6" width="1.5" height="4" rx="0.75" fill="currentColor"/>
                    <rect x="2" y="12" width="1.5" height="4" rx="0.75" fill="currentColor"/>
                    <rect x="20.5" y="6" width="1.5" height="4" rx="0.75" fill="currentColor"/>
                    <rect x="20.5" y="12" width="1.5" height="4" rx="0.75" fill="currentColor"/>
                    <rect x="5" y="3" width="14" height="18" rx="2.5" fill="currentColor"/>
                </svg>
                ì§„ë™
            </button>
        </div>

        <!-- ê²½ë³´ ë²„íŠ¼ -->
        <button class="sup-alert-btn" onclick="triggerSupAlert()">ğŸš¨ ê²½ë³´</button>

        <!-- ê²½ë³´ ì˜¤ë²„ë ˆì´ -->
        <div class="support-alert-overlay" id="supAlertOverlay">
            <div class="sal-top-bar">
                <div class="sal-siren">ğŸš¨</div>
                <div class="sal-title">SOS ê²½ë³´ ë°œìƒ!</div>
                <button class="sal-confirm" onclick="stopSupAlert()">í™•ì¸</button>
            </div>
            <div class="sal-body">
                <div class="sal-flash">ë„ì›€ ìš”ì²­ ì‹ í˜¸ ìˆ˜ì‹  ì¤‘...</div>
                <div class="loc-card">
                    <div class="loc-lbl">ğŸ“ í˜„ì¬ ìœ„ì¹˜</div>
                    <div class="loc-addr" id="supAlertAddr">ìœ„ì¹˜ ì •ë³´ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
                    <div class="loc-coords" id="supAlertCoords"></div>
                    <div class="loc-time" id="supAlertTime"></div>
                </div>
                <div class="map-box">
                    <iframe id="supMapIframe" src="" allowfullscreen></iframe>
                </div>
            </div>
        </div>

    </div>

    <!-- ========== ì„¤ì • í™”ë©´ (ë°œì‹ ) ========== -->
    <div id="senderSettings" class="settings-screen sender-settings">
        <h1 style="font-size:28px;margin-bottom:20px;text-align:center;color:white;font-weight:900;">ì„¤ì •</h1>
        <div class="card">
            <p class="section-title" style="color:white;">ë‚´ ê³ ìœ  ID</p>
            <div class="id-display"><div class="id-text" id="senderId">ë¡œë”©ì¤‘...</div></div>
            <div style="display:flex;gap:10px;margin-top:12px;">
                <button onclick="copySenderId()" style="flex:1;padding:14px;border-radius:12px;border:none;background:#1A5C34;color:white;font-size:16px;font-weight:700;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:6px;">
                    ğŸ“‹ ë³µì‚¬í•˜ê¸°
                </button>
                <button onclick="shareSenderKakao()" style="flex:1;padding:14px;border-radius:12px;border:none;background:#FEE500;color:#3C1E1E;font-size:16px;font-weight:700;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:6px;">
                    ğŸ’¬ ì¹´ì¹´ì˜¤ ê³µìœ 
                </button>
            </div>
            <div id="senderCopyToast" style="display:none;text-align:center;margin-top:10px;font-size:15px;font-weight:700;color:#60a5fa;">âœ… IDê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!</div>
        </div>
        <div class="card">
            <p class="section-title" style="color:white;">ğŸ‘¥ ë³´í˜¸ì ë“±ë¡í•˜ê¸°</p>
            <input type="text" id="senderFriendInput" class="input-box" placeholder="ì˜ˆ: SZ-A1B2" maxlength="15">
            <button class="btn-add" onclick="addSenderFriend()">ë“±ë¡í•˜ê¸°</button>
            <button onclick="startSenderQrScan()" style="width:100%;padding:14px;border-radius:12px;border:2px dashed rgba(255,255,255,0.5);background:rgba(255,255,255,0.1);color:white;font-size:18px;font-weight:700;cursor:pointer;margin-top:10px;">
                ğŸ“· QR ì½”ë“œë¡œ ë“±ë¡í•˜ê¸°
            </button>
            <div id="senderQrScanArea" style="display:none;margin-top:12px;">
                <video id="senderQrVideo" style="width:100%;border-radius:12px;background:#000;" autoplay playsinline></video>
                <button onclick="stopSenderQrScan()" style="width:100%;margin-top:8px;padding:12px;border-radius:12px;border:none;background:rgba(220,38,38,0.8);color:white;font-size:16px;font-weight:700;cursor:pointer;">âŒ ìŠ¤ìº” ì·¨ì†Œ</button>
                <p style="text-align:center;color:rgba(255,255,255,0.7);font-size:14px;margin-top:6px;">ìƒëŒ€ë°©ì˜ QR ì½”ë“œë¥¼ ì¹´ë©”ë¼ì— ë¹„ì¶°ì£¼ì„¸ìš”</p>
            </div>
        </div>
        <div class="card">
            <p class="section-title" style="color:white;">ë“±ë¡ëœ ë³´í˜¸ì ëª©ë¡</p>
            <p style="background:rgba(59,130,246,0.3);padding:6px 16px;border-radius:15px;font-size:18px;display:inline-block;margin:10px 0;color:white;border:2px solid rgba(59,130,246,0.3);">
                <span id="senderCount">0</span>/5ëª…
            </p>
            <div id="senderFriendList"></div>
        </div>
        <div class="card" style="text-align:center;">
            <p class="section-title" style="color:white;">ğŸ“± ë‚´ QR ì½”ë“œ</p>
            <p style="color:rgba(255,255,255,0.7);font-size:14px;margin-bottom:12px;">ìƒëŒ€ë°©ì´ ì´ QRì„ ìŠ¤ìº”í•˜ë©´ ìë™ìœ¼ë¡œ ë“±ë¡ë©ë‹ˆë‹¤</p>
            <div id="senderQrCode" style="display:inline-block;background:white;padding:12px;border-radius:12px;"></div>
        </div>
        <button class="btn-back" onclick="hideSettings()" style="display:none;"></button>
    </div>

    <!-- ========== ì„¤ì • í™”ë©´ (ì§€ì›) ========== -->
    <div id="receiverSettings" class="settings-screen receiver-settings">
        <h1 style="font-size:28px;margin-bottom:20px;text-align:center;color:white;font-weight:900;">ì„¤ì •</h1>
        <div class="card">
            <p class="section-title" style="color:white;">ë‚´ ê³ ìœ  ID</p>
            <div class="id-display"><div class="id-text" id="receiverId">ë¡œë”©ì¤‘...</div></div>
            <!-- ë³µì‚¬ / ì¹´ì¹´ì˜¤ ê³µìœ  ë²„íŠ¼ -->
            <div style="display:flex;gap:10px;margin-top:12px;">
                <button onclick="copyReceiverId()" style="flex:1;padding:14px;border-radius:12px;border:none;background:#1A6B3C;color:white;font-size:16px;font-weight:700;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:6px;">
                    ğŸ“‹ ë³µì‚¬í•˜ê¸°
                </button>
                <button onclick="shareKakao()" style="flex:1;padding:14px;border-radius:12px;border:none;background:#FEE500;color:#3C1E1E;font-size:16px;font-weight:700;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:6px;">
                    ğŸ’¬ ì¹´ì¹´ì˜¤ ê³µìœ 
                </button>
            </div>
            <div id="copyToast" style="display:none;text-align:center;margin-top:10px;font-size:15px;font-weight:700;color:#00FF7F;">âœ… IDê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!</div>
        </div>
        <div class="card">
            <p class="section-title" style="color:white;">ğŸ›¡ï¸ ë³´í˜¸ëŒ€ìƒì ë“±ë¡í•˜ê¸°</p>
            <!-- ì§ì ‘ ì…ë ¥ -->
            <input type="text" id="receiverFriendInput" class="input-box" placeholder="ì˜ˆ: SZ-A1B2" maxlength="15">
            <button class="btn-add" onclick="addReceiverFriend()">ë“±ë¡í•˜ê¸°</button>
            <!-- QR ìŠ¤ìº” -->
            <button onclick="startQrScan()" style="width:100%;padding:14px;border-radius:12px;border:2px dashed rgba(255,255,255,0.5);background:rgba(255,255,255,0.1);color:white;font-size:18px;font-weight:700;cursor:pointer;margin-top:10px;">
                ğŸ“· QR ì½”ë“œë¡œ ë“±ë¡í•˜ê¸°
            </button>
            <!-- QR ìŠ¤ìºë„ˆ ì˜ì—­ -->
            <div id="qrScanArea" style="display:none;margin-top:12px;">
                <video id="qrVideo" style="width:100%;border-radius:12px;background:#000;" autoplay playsinline></video>
                <button onclick="stopQrScan()" style="width:100%;margin-top:8px;padding:12px;border-radius:12px;border:none;background:rgba(220,38,38,0.8);color:white;font-size:16px;font-weight:700;cursor:pointer;">âŒ ìŠ¤ìº” ì·¨ì†Œ</button>
                <p style="text-align:center;color:rgba(255,255,255,0.7);font-size:14px;margin-top:6px;">ìƒëŒ€ë°©ì˜ QR ì½”ë“œë¥¼ ì¹´ë©”ë¼ì— ë¹„ì¶°ì£¼ì„¸ìš”</p>
            </div>
        </div>
        <div class="card">
            <p class="section-title" style="color:white;">ë³´í˜¸ëŒ€ìƒì ëª©ë¡</p>
            <p style="background:rgba(59,130,246,0.3);padding:6px 16px;border-radius:15px;font-size:18px;display:inline-block;margin:10px 0;color:white;border:2px solid rgba(59,130,246,0.3);">
                <span id="receiverCount">0</span>/5ëª…
            </p>
            <div id="receiverFriendList"></div>
        </div>
        <!-- QR ë‚´ ID ë³´ì—¬ì£¼ê¸° -->
        <div class="card" style="text-align:center;">
            <p class="section-title" style="color:white;">ğŸ“± ë‚´ QR ì½”ë“œ</p>
            <p style="color:rgba(255,255,255,0.7);font-size:14px;margin-bottom:12px;">ìƒëŒ€ë°©ì´ ì´ QRì„ ìŠ¤ìº”í•˜ë©´ ìë™ìœ¼ë¡œ ë“±ë¡ë©ë‹ˆë‹¤</p>
            <div id="myQrCode" style="display:inline-block;background:white;padding:12px;border-radius:12px;"></div>
        </div>
        <button class="btn-back" onclick="hideSettings()" style="display:none;"></button>
    </div>

    <script>
        /* ===== ID ì´ˆê¸°í™” ===== */
        let senderId = localStorage.getItem('safeZoneID_SND');
        if (!senderId) { senderId = 'SZ-' + Math.random().toString(36).substr(2,4).toUpperCase(); localStorage.setItem('safeZoneID_SND', senderId); }
        document.getElementById('senderId').innerText = senderId;

        let receiverId = localStorage.getItem('safeZoneID_RCV');
        if (!receiverId) { receiverId = 'SZ-' + Math.random().toString(36).substr(2,4).toUpperCase(); localStorage.setItem('safeZoneID_RCV', receiverId); }
        document.getElementById('receiverId').innerText = receiverId;

        let currentMode = localStorage.getItem('currentMode') || 'sender';

        /* ===== í™”ë©´ ì „í™˜ ===== */
        window.toggleMode = function() {
            const sender = document.getElementById('senderScreen');
            const receiver = document.getElementById('receiverScreen');
            const header = document.getElementById('topHeader');
            const title = document.getElementById('headerTitle');
            const dot = document.getElementById('headerDot');
            const p1 = document.getElementById('swPath1');
            const p2 = document.getElementById('swPath2');

            if (currentMode === 'sender') {
                currentMode = 'receiver';
                // í—¤ë” â†’ ë…¹ìƒ‰
                header.className = 'top-header support-header';
                title.textContent = 'SOS ì§€ì› ëª¨ë“œ';
                title.style.color = 'white';
                dot.style.display = '';
                p1.setAttribute('stroke','rgba(255,255,255,0.9)');
                p2.setAttribute('stroke','rgba(255,255,255,0.9)');
                sender.classList.remove('active');
                receiver.classList.add('active');
                setTimeout(() => { if (window.startListening) window.startListening(); }, 500);
            } else {
                currentMode = 'sender';
                // í—¤ë” â†’ íŒŒë€ìƒ‰
                header.className = 'top-header sender-header';
                title.textContent = 'SOS ìš”ì²­ ëª¨ë“œ';
                title.style.color = 'white';
                dot.style.display = 'none';
                p1.setAttribute('stroke','rgba(255,255,255,0.9)');
                p2.setAttribute('stroke','rgba(255,255,255,0.9)');
                receiver.classList.remove('active');
                sender.classList.add('active');
                stopSupAlert();
            }
            localStorage.setItem('currentMode', currentMode);
        };

        /* ===== ì„¤ì • ===== */
        window.showSettings = function() {
            if (currentMode === 'sender') { document.getElementById('senderSettings').classList.add('active'); loadSenderFriends(); generateSenderQR(); }
            else { document.getElementById('receiverSettings').classList.add('active'); loadReceiverFriends(); generateMyQR(); }
            // ì „í™˜ë²„íŠ¼ â†’ ëŒì•„ê°€ê¸°
            document.getElementById('switchBtn').innerHTML = '<span style="font-size:15px;font-weight:900;color:white;white-space:nowrap;">ëŒì•„ê°€ê¸°</span>';
            document.getElementById('switchBtn').onclick = hideSettings;
            // í†±ë‹ˆë°”í€´ëŠ” ê·¸ëŒ€ë¡œ ìœ ì§€
            document.getElementById('settingIconBtn').innerHTML = 'âš™ï¸';
            document.getElementById('settingIconBtn').onclick = null;
        };
        window.hideSettings = function() {
            document.getElementById('senderSettings').classList.remove('active');
            document.getElementById('receiverSettings').classList.remove('active');
            // ì „í™˜ë²„íŠ¼ ë³µì›
            document.getElementById('switchBtn').innerHTML = `<svg width="22" height="22" viewBox="0 0 24 24" fill="none">
                <path id="swPath1" d="M7 16H20M20 16L17 13M20 16L17 19" stroke="rgba(255,255,255,0.9)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                <path id="swPath2" d="M17 8H4M4 8L7 5M4 8L7 11" stroke="rgba(255,255,255,0.9)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>`;
            document.getElementById('switchBtn').onclick = toggleMode;
            document.getElementById('settingIconBtn').onclick = showSettings;
        };

        window.addSenderFriend = function() {
            const input = document.getElementById('senderFriendInput');
            let id = input.value.trim().toUpperCase();
            if (!id) { alert('âŒ IDë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”!'); return; }
            if (!id.startsWith('SZ-')) id = 'SZ-' + id;
            let list = JSON.parse(localStorage.getItem('friendList_SND') || '[]');
            if (list.length >= 5) { alert('âŒ ìµœëŒ€ 5ëª…ê¹Œì§€!'); return; }
            if (list.includes(id)) { alert('âŒ ì´ë¯¸ ë“±ë¡ë¨!'); return; }
            list.push(id); localStorage.setItem('friendList_SND', JSON.stringify(list));
            input.value = ''; alert('âœ… ë“±ë¡: ' + id); loadSenderFriends();
        };
        window.deleteSenderFriend = function(id) {
            if (!confirm('âš ï¸ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
            let list = JSON.parse(localStorage.getItem('friendList_SND') || '[]');
            list = list.filter(f => f !== id); localStorage.setItem('friendList_SND', JSON.stringify(list)); loadSenderFriends();
        };
        function loadSenderFriends() {
            const list = JSON.parse(localStorage.getItem('friendList_SND') || '[]');
            document.getElementById('senderCount').innerText = list.length;
            const cont = document.getElementById('senderFriendList');
            cont.innerHTML = list.length === 0
                ? '<p style="text-align:center;opacity:0.7;margin-top:14px;font-size:18px;color:white;">ë“±ë¡ëœ ì¹œêµ¬ê°€ ì—†ìŠµë‹ˆë‹¤</p>'
                : list.map(f => `<div class="friend-item" style="color:white;"><span>âœ… ${f}</span><button class="btn-delete" onclick="deleteSenderFriend('${f}')">âœ•</button></div>`).join('');
        }

        window.addReceiverFriend = function() {
            const input = document.getElementById('receiverFriendInput');
            let id = input.value.trim().toUpperCase();
            if (!id) { alert('âŒ IDë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”!'); return; }
            if (!id.startsWith('SZ-')) id = 'SZ-' + id;
            let list = JSON.parse(localStorage.getItem('friendList_RCV') || '[]');
            if (list.length >= 5) { alert('âŒ ìµœëŒ€ 5ëª…ê¹Œì§€!'); return; }
            if (list.includes(id)) { alert('âŒ ì´ë¯¸ ë“±ë¡ë¨!'); return; }
            list.push(id); localStorage.setItem('friendList_RCV', JSON.stringify(list));
            input.value = ''; alert('âœ… ë“±ë¡: ' + id); loadReceiverFriends();
            setTimeout(() => { if (window.startListening) window.startListening(); }, 500);
        };
        window.deleteReceiverFriend = function(id) {
            if (!confirm('âš ï¸ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
            let list = JSON.parse(localStorage.getItem('friendList_RCV') || '[]');
            list = list.filter(f => f !== id); localStorage.setItem('friendList_RCV', JSON.stringify(list)); loadReceiverFriends();
        };
        function loadReceiverFriends() {
            const list = JSON.parse(localStorage.getItem('friendList_RCV') || '[]');
            document.getElementById('receiverCount').innerText = list.length;
            const cont = document.getElementById('receiverFriendList');
            cont.innerHTML = list.length === 0
                ? '<p style="text-align:center;opacity:0.7;margin-top:14px;font-size:18px;color:white;">ë“±ë¡ëœ ì¹œêµ¬ê°€ ì—†ìŠµë‹ˆë‹¤</p>'
                : list.map(f => `<div class="friend-item" style="color:white;"><span>âœ… ${f}</span><button class="btn-delete" onclick="deleteReceiverFriend('${f}')">âœ•</button></div>`).join('');
        }

        /* ===== ë°œì‹  ë³µì‚¬í•˜ê¸° ===== */
        window.copySenderId = function() {
            const id = localStorage.getItem('safeZoneID_SND') || '';
            if (navigator.clipboard) {
                navigator.clipboard.writeText(id).then(() => showSenderCopyToast());
            } else {
                const el = document.createElement('textarea');
                el.value = id; document.body.appendChild(el);
                el.select(); document.execCommand('copy');
                document.body.removeChild(el);
                showSenderCopyToast();
            }
        };
        function showSenderCopyToast() {
            const t = document.getElementById('senderCopyToast');
            t.style.display = 'block';
            setTimeout(() => { t.style.display = 'none'; }, 2500);
        }

        /* ===== ë°œì‹  ì¹´ì¹´ì˜¤ ê³µìœ  ===== */
        window.shareSenderKakao = function() {
            const id = localStorage.getItem('safeZoneID_SND') || '';
            const msg = `ArtOfStreet ì•ˆì „ì§€ëŒ€ - ë‚´ ID: ${id}\nì´ IDë¥¼ ì•±ì— ë“±ë¡í•˜ë©´ ë‚˜ë¥¼ ë³´í˜¸í•  ìˆ˜ ìˆì–´ìš”!`;
            if (navigator.share) {
                navigator.share({ title: 'SOS ì•ˆì „ì§€ëŒ€ ID ê³µìœ ', text: msg }).catch(() => {});
            } else {
                window.open(`https://sharer.kakao.com/talk/friends/picker/link?text=${encodeURIComponent(msg)}`, '_blank');
            }
        };

        /* ===== ë°œì‹  QR ìƒì„± ===== */
        function generateSenderQR() {
            const id = localStorage.getItem('safeZoneID_SND') || '';
            const qrDiv = document.getElementById('senderQrCode');
            qrDiv.innerHTML = '';
            const img = document.createElement('img');
            img.src = `https://api.qrserver.com/v1/create-qr-code/?size=160x160&data=${encodeURIComponent(id)}&bgcolor=ffffff&color=000000&margin=2`;
            img.style.cssText = 'width:160px;height:160px;border-radius:8px;';
            qrDiv.appendChild(img);
        }

        /* ===== ë°œì‹  QR ìŠ¤ìº” ===== */
        let senderQrStream = null, senderQrInterval = null;
        window.startSenderQrScan = async function() {
            document.getElementById('senderQrScanArea').style.display = 'block';
            try {
                senderQrStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
                const video = document.getElementById('senderQrVideo');
                video.srcObject = senderQrStream;
                if ('BarcodeDetector' in window) {
                    const detector = new BarcodeDetector({ formats: ['qr_code'] });
                    senderQrInterval = setInterval(async () => {
                        try {
                            const codes = await detector.detect(video);
                            if (codes.length > 0) {
                                const raw = codes[0].rawValue.trim().toUpperCase();
                                const id = raw.startsWith('SZ-') ? raw : 'SZ-' + raw;
                                stopSenderQrScan();
                                document.getElementById('senderFriendInput').value = id;
                                alert(`âœ… QR ìŠ¤ìº” ì™„ë£Œ: ${id}\n"ë“±ë¡í•˜ê¸°" ë²„íŠ¼ì„ ëˆŒëŸ¬ ì¶”ê°€í•˜ì„¸ìš”!`);
                            }
                        } catch(e) {}
                    }, 500);
                } else {
                    alert('ì´ ë¸Œë¼ìš°ì €ëŠ” QR ìŠ¤ìº”ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.\nì§ì ‘ IDë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                    stopSenderQrScan();
                }
            } catch(e) {
                alert('ì¹´ë©”ë¼ ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤.');
                document.getElementById('senderQrScanArea').style.display = 'none';
            }
        };
        window.stopSenderQrScan = function() {
            if (senderQrStream) { senderQrStream.getTracks().forEach(t => t.stop()); senderQrStream = null; }
            if (senderQrInterval) { clearInterval(senderQrInterval); senderQrInterval = null; }
            document.getElementById('senderQrScanArea').style.display = 'none';
        };

        /* ===== ë³µì‚¬í•˜ê¸° ===== */
        window.copyReceiverId = function() {
            const id = localStorage.getItem('safeZoneID_RCV') || '';
            if (navigator.clipboard) {
                navigator.clipboard.writeText(id).then(() => showCopyToast());
            } else {
                const el = document.createElement('textarea');
                el.value = id; document.body.appendChild(el);
                el.select(); document.execCommand('copy');
                document.body.removeChild(el);
                showCopyToast();
            }
        };
        function showCopyToast() {
            const t = document.getElementById('copyToast');
            t.style.display = 'block';
            setTimeout(() => { t.style.display = 'none'; }, 2500);
        }

        /* ===== ì¹´ì¹´ì˜¤ ê³µìœ  ===== */
        window.shareKakao = function() {
            const id = localStorage.getItem('safeZoneID_RCV') || '';
            const msg = `ArtOfStreet ì•ˆì „ì§€ëŒ€ - ë‚´ ID: ${id}\nì´ IDë¥¼ ì•±ì— ë“±ë¡í•˜ë©´ ë‚˜ë¥¼ ë³´í˜¸í•  ìˆ˜ ìˆì–´ìš”!`;
            if (navigator.share) {
                navigator.share({ title: 'SOS ì•ˆì „ì§€ëŒ€ ID ê³µìœ ', text: msg })
                    .catch(() => {});
            } else {
                const kakaoUrl = `https://sharer.kakao.com/talk/friends/picker/link?app_key=5d19f896badf6fdab5297f129bffaf1e&text=${encodeURIComponent(msg)}`;
                window.open(kakaoUrl, '_blank');
            }
        };

        /* ===== QR ì½”ë“œ ìƒì„± (ë‚´ ID) ===== */
        function generateMyQR() {
            const id = localStorage.getItem('safeZoneID_RCV') || '';
            const qrDiv = document.getElementById('myQrCode');
            qrDiv.innerHTML = '';
            const size = 160;
            const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=${size}x${size}&data=${encodeURIComponent(id)}&bgcolor=ffffff&color=000000&margin=2`;
            const img = document.createElement('img');
            img.src = qrUrl;
            img.style.cssText = `width:${size}px;height:${size}px;border-radius:8px;`;
            qrDiv.appendChild(img);
        }

        /* ===== QR ìŠ¤ìº” ===== */
        let qrStream = null;
        let qrScanInterval = null;

        window.startQrScan = async function() {
            document.getElementById('qrScanArea').style.display = 'block';
            try {
                qrStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
                const video = document.getElementById('qrVideo');
                video.srcObject = qrStream;
                // BarcodeDetector API ì§€ì› ì‹œ ì‚¬ìš©
                if ('BarcodeDetector' in window) {
                    const detector = new BarcodeDetector({ formats: ['qr_code'] });
                    qrScanInterval = setInterval(async () => {
                        try {
                            const codes = await detector.detect(video);
                            if (codes.length > 0) {
                                const raw = codes[0].rawValue.trim().toUpperCase();
                                const id = raw.startsWith('SZ-') ? raw : 'SZ-' + raw;
                                stopQrScan();
                                document.getElementById('receiverFriendInput').value = id;
                                alert(`âœ… QR ìŠ¤ìº” ì™„ë£Œ: ${id}\n"ë“±ë¡í•˜ê¸°" ë²„íŠ¼ì„ ëˆŒëŸ¬ ì¶”ê°€í•˜ì„¸ìš”!`);
                            }
                        } catch(e) {}
                    }, 500);
                } else {
                    alert('ì´ ë¸Œë¼ìš°ì €ëŠ” QR ìŠ¤ìº”ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.\nì§ì ‘ IDë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                    stopQrScan();
                }
            } catch(e) {
                alert('ì¹´ë©”ë¼ ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤.');
                document.getElementById('qrScanArea').style.display = 'none';
            }
        };

        window.stopQrScan = function() {
            if (qrStream) { qrStream.getTracks().forEach(t => t.stop()); qrStream = null; }
            if (qrScanInterval) { clearInterval(qrScanInterval); qrScanInterval = null; }
            document.getElementById('qrScanArea').style.display = 'none';
        };

        /* ===== ì„¤ì • ì—´ë¦´ ë•Œ QR ìë™ ìƒì„± ===== */
        let supAlertMode = 'sound';
        window.setSupMode = function(mode) {
            supAlertMode = mode;
            document.getElementById('supSoundBtn').classList.toggle('active', mode === 'sound');
            document.getElementById('supVibrateBtn').classList.toggle('active', mode === 'vibrate');
        };

        /* ===== ì§€ì›ëª¨ë“œ ê²½ë³´ ===== */
        let supAlerting = false;
        let supSirenTimer = null;
        let supVibrateInterval = null;
        let supAudioCtx = null;

        function playSupSiren() {
            if (!supAlerting) return;
            try {
                if (supAudioCtx) supAudioCtx.close();
                supAudioCtx = new (window.AudioContext || window.webkitAudioContext)();
                for (let i = 0; i < 4; i++) {
                    const osc = supAudioCtx.createOscillator();
                    const gain = supAudioCtx.createGain();
                    osc.connect(gain); gain.connect(supAudioCtx.destination);
                    const t = supAudioCtx.currentTime + i * 0.52;
                    osc.frequency.setValueAtTime(700, t);
                    osc.frequency.linearRampToValueAtTime(1050, t + 0.26);
                    osc.frequency.linearRampToValueAtTime(700, t + 0.48);
                    gain.gain.setValueAtTime(0.3, t);
                    gain.gain.linearRampToValueAtTime(0, t + 0.48);
                    osc.start(t); osc.stop(t + 0.5);
                }
                supSirenTimer = setTimeout(playSupSiren, 2200);
            } catch(e) {}
        }

        window.triggerSupAlert = function() {
            if (supAlerting) return;
            supAlerting = true;
            document.getElementById('receiverScreen').classList.add('alerting');
            document.getElementById('supAlertOverlay').classList.add('visible');

            if (supAlertMode === 'sound') {
                playSupSiren();
            } else {
                supVibrateInterval = setInterval(() => { if (navigator.vibrate) navigator.vibrate([300,100,300]); }, 800);
            }

            const now = new Date();
            document.getElementById('supAlertTime').textContent =
                `${now.getFullYear()}.${pad(now.getMonth()+1)}.${pad(now.getDate())} ${pad(now.getHours())}:${pad(now.getMinutes())}:${pad(now.getSeconds())}`;

            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(pos => {
                    const lat = pos.coords.latitude.toFixed(6);
                    const lng = pos.coords.longitude.toFixed(6);
                    document.getElementById('supAlertCoords').textContent = `ìœ„ë„ ${lat}  ê²½ë„ ${lng}`;
                    fetch(`https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lng}&format=json&accept-language=ko`)
                        .then(r=>r.json()).then(d=>{
                            document.getElementById('supAlertAddr').textContent = d.display_name || `${lat}, ${lng}`;
                        }).catch(()=>{ document.getElementById('supAlertAddr').textContent = `${lat}, ${lng}`; });
                    document.getElementById('supMapIframe').src =
                        `https://www.openstreetmap.org/export/embed.html?bbox=${+lng-0.005},${+lat-0.005},${+lng+0.005},${+lat+0.005}&layer=mapnik&marker=${lat},${lng}`;
                }, useSupDefault);
            } else { useSupDefault(); }
        };

        function useSupDefault() {
            document.getElementById('supAlertAddr').textContent = 'ì„œìš¸íŠ¹ë³„ì‹œ ì¤‘êµ¬ ì„¸ì¢…ëŒ€ë¡œ 110';
            document.getElementById('supAlertCoords').textContent = 'ìœ„ë„ 37.566535  ê²½ë„ 126.977969';
            document.getElementById('supMapIframe').src = 'https://www.openstreetmap.org/export/embed.html?bbox=126.972969,37.561535,126.982969,37.571535&layer=mapnik&marker=37.566535,126.977969';
        }

        window.stopSupAlert = function() {
            supAlerting = false;
            document.getElementById('receiverScreen').classList.remove('alerting');
            document.getElementById('supAlertOverlay').classList.remove('visible');
            if (supSirenTimer) { clearTimeout(supSirenTimer); supSirenTimer = null; }
            if (supVibrateInterval) { clearInterval(supVibrateInterval); supVibrateInterval = null; }
            if (navigator.vibrate) navigator.vibrate(0);
            if (supAudioCtx) { try { supAudioCtx.close(); } catch(e){} supAudioCtx = null; }
            document.getElementById('supMapIframe').src = '';
        };

        function pad(n) { return String(n).padStart(2,'0'); }

        /* ===== ì´ˆê¸° ëª¨ë“œ ë³µì› ===== */
        window.addEventListener('load', () => {
            if (currentMode === 'receiver') {
                document.getElementById('senderScreen').classList.remove('active');
                document.getElementById('receiverScreen').classList.add('active');
                document.getElementById('topHeader').className = 'top-header support-header';
                document.getElementById('headerTitle').textContent = 'SOS ì§€ì› ëª¨ë“œ';                document.getElementById('headerDot').style.display = '';
                setTimeout(() => { if (window.startListening) window.startListening(); }, 2000);
            }
        });
    </script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
        import { getDatabase, ref, set, remove, serverTimestamp, onValue } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCJnlwuftFUmmazQg-riYRewSeKRjBB8g",
            databaseURL: "https://safezone-2c1b2-default-rtdb.firebaseio.com",
            projectId: "safezone-2c1b2",
            appId: "1:181205095456:web:da0a519ff43cc19e7b1845"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const geocoder = new kakao.maps.services.Geocoder();

        window.isTracking = false;
        let watchId = null;
        const statusMsg = document.getElementById('statusMsg');
        const trackingBadge = document.getElementById('trackingBadge');
        const emergencyBtn = document.getElementById('emergencyBtn');

        emergencyBtn.addEventListener('touchstart', function() {
            if (navigator.vibrate) navigator.vibrate([500, 100, 500, 100, 800]);
        }, { passive: false });

        emergencyBtn.addEventListener('click', function(e) {
            e.preventDefault();
            if (!window.isTracking) { startTracking(); } else { stopTracking(); }
        });

        function startTracking() {
            const myID = localStorage.getItem('safeZoneID_SND')?.trim().toUpperCase();
            if (!myID) { alert('âŒ ID ì—†ìŒ'); return; }

            const emergencyRef = ref(db, 'emergency_global');
            const sendTime = new Date().toLocaleTimeString();

            set(emergencyRef, {
                sender: myID, address: 'ìœ„ì¹˜ í™•ì¸ ì¤‘...', lat: 37.5665, lon: 126.9780,
                mapUrl: 'https://map.kakao.com/', time: sendTime,
                timestamp: serverTimestamp(), status: 'emergency'
            }).then(() => {
                statusMsg.innerText = "âœ… ê¸´ê¸‰ ì‹ í˜¸ ì „ì†¡ë¨!";
                if (navigator.vibrate) navigator.vibrate([200, 100, 200]);
            }).catch(err => { alert('âŒ ì „ì†¡ ì‹¤íŒ¨!\n\n' + err.message); return; });

            statusMsg.innerText = "ğŸ“ ìœ„ì¹˜ í™•ì¸ ì¤‘...";

            watchId = navigator.geolocation.watchPosition(pos => {
                const lat = pos.coords.latitude;
                const lon = pos.coords.longitude;
                geocoder.coord2Address(lon, lat, (result, status) => {
                    let addr = 'ì£¼ì†Œ í™•ì¸ ë¶ˆê°€';
                    if (status === kakao.maps.services.Status.OK && result[0]) {
                        addr = result[0].road_address ? result[0].road_address.address_name : result[0].address.address_name;
                    }
                    set(emergencyRef, {
                        sender: myID, address: addr, lat, lon,
                        mapUrl: `https://map.kakao.com/link/map/ê¸´ê¸‰êµ¬ì¡°,${lat},${lon}`,
                        time: new Date().toLocaleTimeString(), timestamp: serverTimestamp(), status: 'emergency'
                    });
                    statusMsg.innerText = "âœ… " + addr.substring(0, 22) + "...";
                });
            }, () => { statusMsg.innerText = "âš ï¸ ìœ„ì¹˜ ë¶ˆê°€ (ì‹ í˜¸ ì „ì†¡ë¨)"; },
            { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 });

            window.isTracking = true;
            emergencyBtn.classList.add('tracking');
            trackingBadge.style.display = 'inline-block';
        }

        function stopTracking() {
            if (watchId) { navigator.geolocation.clearWatch(watchId); watchId = null; }
            remove(ref(db, 'emergency_global'));
            window.isTracking = false;
            emergencyBtn.classList.remove('tracking');
            trackingBadge.style.display = 'none';
            statusMsg.innerText = "âœ… ì¶”ì  ì¢…ë£Œ";
        }

        window.startTracking = startTracking;
        window.stopTracking = stopTracking;

        /* ===== Firebase ìˆ˜ì‹  (ì§€ì›ëª¨ë“œ) ===== */
        let currentEmergency = null;

        window.startListening = function() {
            const friendList = JSON.parse(localStorage.getItem('friendList_RCV') || '[]');
            const globalRef = ref(db, 'emergency_global');

            onValue(globalRef, (snap) => {
                const data = snap.val();
                if (!data) {
                    currentEmergency = null;
                    window.stopSupAlert && window.stopSupAlert();
                    return;
                }
                const senderID = data.sender;
                if (friendList.length === 0 || friendList.includes(senderID)) {
                    if (currentEmergency !== senderID) {
                        currentEmergency = senderID;
                        // Firebase ê²½ë³´ ìˆ˜ì‹  ì‹œ ìë™ ê²½ë³´ ë°œë™
                        if (!supAlerting) {
                            window.triggerSupAlert();
                            // ìœ„ì¹˜ë¥¼ Firebase ë°ì´í„°ë¡œ ë®ì–´ì“°ê¸°
                            if (data.address) document.getElementById('supAlertAddr').textContent = data.address;
                            if (data.lat && data.lon) {
                                document.getElementById('supAlertCoords').textContent = `ìœ„ë„ ${data.lat}  ê²½ë„ ${data.lon}`;
                                document.getElementById('supMapIframe').src =
                                    `https://www.openstreetmap.org/export/embed.html?bbox=${data.lon-0.005},${data.lat-0.005},${data.lon+0.005},${data.lat+0.005}&layer=mapnik&marker=${data.lat},${data.lon}`;
                            }
                        }
                    }
                }
            });
        };

        // ì¹´ì¹´ì˜¤ë§µì€ ìˆ¨ê²¨ì§„ divì—ë§Œ ìœ ì§€ (í•„ìš”ì‹œ í™œìš©)
        const dummyMap = document.createElement('div');
        dummyMap.style.cssText = 'width:1px;height:1px;position:absolute;left:-9999px;';
        document.body.appendChild(dummyMap);
        const kakaoMap = new kakao.maps.Map(dummyMap, { center: new kakao.maps.LatLng(37.5665, 126.9780), level: 3 });
        window.kakaoMap = kakaoMap;
    </script>
</body>
</html>
