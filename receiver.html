<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì•ˆì „ì§€ëŒ€ ìˆ˜ì‹ ì†Œ</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: sans-serif; }
        body { height: 100vh; display: flex; flex-direction: column; align-items: center; justify-content: center; color: white; text-align: center; transition: background 0.5s; padding: 20px; }
        
        .safe { background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); }
        .emergency { background: linear-gradient(135deg, #ff0844 0%, #ff4757 100%); animation: blink 1s infinite alternate; }
        @keyframes blink { from { opacity: 1; } to { opacity: 0.8; } }

        h1 { font-size: 40px; margin-bottom: 20px; font-weight: 900; }
        p { font-size: 24px; margin: 10px 0; background: rgba(0,0,0,0.2); padding: 15px; border-radius: 10px; width: 100%; max-width: 400px; }
        
        #startSoundBtn {
            margin-top: 30px; padding: 20px 40px; font-size: 22px; font-weight: bold;
            color: white; background: rgba(0,0,0,0.5); border: 2px solid white; border-radius: 50px;
            cursor: pointer; box-shadow: 0 10px 20px rgba(0,0,0,0.3);
        }

        #resetBtn {
            display: none; 
            margin-top: 30px; padding: 20px 40px; font-size: 24px; font-weight: bold;
            color: #ff4757; background: white; border: none; border-radius: 50px;
            cursor: pointer; box-shadow: 0 10px 20px rgba(0,0,0,0.3);
        }
    </style>
</head>
<body id="bg" class="safe">

    <h1 id="statusText">âœ… í˜„ì¬ ì•ˆì „í•©ë‹ˆë‹¤</h1>
    <p id="timeText">ëŒ€ê¸° ì¤‘...</p>
    <p id="msgText">ìˆ˜ì‹  ëŒ€ê¸° ì¤‘</p>

    <button id="startSoundBtn" onclick="unlockSound()">ğŸ”Š í„°ì¹˜í•´ì„œ ìŠ¤í”¼ì»¤ ì¼œê¸°</button>
    <button id="resetBtn" onclick="resetEmergency()">ìƒí™© ì¢…ë£Œ (ì•ŒëŒ ë„ê¸°)</button>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
        import { getDatabase, ref, onValue, remove } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCJnlwuftFUmmazQg-riYRewSeKRjBB8g",
            authDomain: "safezone-2c1b2.firebaseapp.com",
            databaseURL: "https://safezone-2c1b2-default-rtdb.firebaseio.com",
            projectId: "safezone-2c1b2",
            storageBucket: "safezone-2c1b2.firebasestorage.app",
            messagingSenderId: "181205095456",
            appId: "1:181205095456:web:da0a519ff43cc19e7b1845",
            measurementId: "G-X6QBMSL7DS"
        };

        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);
        const emergencyRef = ref(database, 'emergency_signal');

        // í•¸ë“œí° ë‚´ì¥ ë¶€ì € ì—”ì§„ ì¤€ë¹„!
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        window.sirenOscillator = null;
        window.sirenInterval = null;

        // ìŠ¤í”¼ì»¤ ì‹œë™ ê±¸ê¸°
        window.unlockSound = function() {
            audioCtx.resume(); // ë¶€ì € ì—”ì§„ ì‹œë™ ì¼¬!
            
            const ut = new SpeechSynthesisUtterance("ìˆ˜ì‹  ëŒ€ê¸°ë¥¼ ì‹œì‘í•©ë‹ˆë‹¤.");
            ut.lang = 'ko-KR';
            window.speechSynthesis.speak(ut);
            
            document.getElementById('startSoundBtn').innerText = "âœ… ìŠ¤í”¼ì»¤ ì¼œì§ (ìˆ˜ì‹  ëŒ€ê¸°ì¤‘)";
            document.getElementById('startSoundBtn').style.background = "white";
            document.getElementById('startSoundBtn').style.color = "#11998e";
            document.getElementById('startSoundBtn').onclick = null; 
        };

        // [ì‹¤ì‹œê°„ ê°ì‹œ]
        onValue(emergencyRef, (snapshot) => {
            const data = snapshot.val();
            
            if (data) {
                document.getElementById('statusText').innerText = "ğŸš¨ ê¸´ê¸‰ ìƒí™© ë°œìƒ!!";
                document.getElementById('timeText').innerText = "ì‹œê°„: " + data.time;
                document.getElementById('msgText').innerText = data.message;
                document.getElementById('bg').className = "emergency";
                document.getElementById('resetBtn').style.display = "block"; 
                document.getElementById('startSoundBtn').style.display = "none";

                // ğŸš¨ 1. í•¸ë“œí° ë‚´ì¥ ë¶€ì €ë¡œ ê¸°ê³„ìŒ ì‚¬ì´ë Œ í„°ëœ¨ë¦¬ê¸°! (ì—„ì²­ ì‹œë„ëŸ¬ì›€!)
                if(!window.sirenOscillator) {
                    window.sirenOscillator = audioCtx.createOscillator();
                    window.sirenOscillator.type = 'square'; // ë‚ ì¹´ë¡œìš´ ê¸°ê³„ìŒ ì†Œë¦¬
                    window.sirenOscillator.connect(audioCtx.destination);
                    window.sirenOscillator.start();
                    
                    // 0.5ì´ˆë§ˆë‹¤ ìŒë†’ì´ë¥¼ ë°”ê¿”ì„œ ì‚¬ì´ë Œ ì†Œë¦¬ ë§Œë“¤ê¸°
                    window.sirenInterval = setInterval(() => {
                        window.sirenOscillator.frequency.value = window.sirenOscillator.frequency.value === 800 ? 1200 : 800;
                    }, 500);
                }

                // ğŸ”Š 2. ì§„ì§€í•œ ìƒí™© ì•ˆë‚´ ëª©ì†Œë¦¬
                const ut = new SpeechSynthesisUtterance("ì¥í™”ë‹˜ì˜ ê¸´ê¸‰ êµ¬ì¡° ìš”ì²­ì…ë‹ˆë‹¤. ì¦‰ì‹œ í™•ì¸í•˜ì‹­ì‹œì˜¤.");
                ut.lang = 'ko-KR';
                window.speechSynthesis.speak(ut);
            } else {
                document.getElementById('statusText').innerText = "âœ… í˜„ì¬ ì•ˆì „í•©ë‹ˆë‹¤";
                document.getElementById('timeText').innerText = "ëŒ€ê¸° ì¤‘...";
                document.getElementById('msgText').innerText = "ìˆ˜ì‹  ëŒ€ê¸° ì¤‘";
                document.getElementById('bg').className = "safe";
                document.getElementById('resetBtn').style.display = "none"; 
                document.getElementById('startSoundBtn').style.display = "block"; 
            }
        });

        // ë„ê¸° ë²„íŠ¼ ëˆ„ë¥´ë©´ ê¸°ê³„ìŒ ì… ë§‰ê¸°!
        window.resetEmergency = function() {
            if(window.sirenOscillator) {
                window.sirenOscillator.stop();
                clearInterval(window.sirenInterval);
                window.sirenOscillator = null;
            }
            remove(emergencyRef); 
        };
    </script>
</body>
</html>
