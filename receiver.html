<!DOCTYPE html>
<html lang="ko" style="background: #11998e;">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#11998e">
    <title>ì•ˆì „ì§€ëŒ€ ìˆ˜ì‹ ì†Œ</title>
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        html { 
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%) !important;
            min-height: 100vh;
        }
        
        body { 
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%) !important;
            color: white !important;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: sans-serif;
            position: fixed;
            width: 100%;
            height: 100%;
            overflow: hidden;
            touch-action: manipulation;
        }
        
        body.emergency { 
            background: linear-gradient(135deg, #ff0844 0%, #ff4757 100%) !important;
            animation: blink 1s infinite alternate;
        }
        
        @keyframes blink { from { opacity: 1; } to { opacity: 0.8; } }
        
        .screen { 
            display: none; 
            width: 100%; 
            height: 100%; 
            flex-direction: column; 
            align-items: center; 
            padding: 20px;
            position: absolute;
            top: 0;
            left: 0;
            overflow-y: auto;
        }
        
        .active { display: flex !important; }
        #mainScreen { justify-content: center; overflow: hidden; }
        #setScreen { justify-content: flex-start; padding-top: 60px; }
        
        .gear-btn { 
            position: absolute; 
            top: 20px; 
            right: 20px; 
            width: 45px; 
            height: 45px; 
            background: rgba(255,255,255,0.2); 
            border: none; 
            border-radius: 50%; 
            font-size: 24px; 
            cursor: pointer; 
            z-index: 999;
        }
        
        h1 { font-size: 32px; margin-bottom: 40px; color: white !important; }
        
        .btn-dark { 
            background: rgba(0,0,0,0.2) !important; 
            color: white !important;
            padding: 20px; 
            width: 90%; 
            max-width: 350px; 
            font-size: 20px; 
            font-weight: bold; 
            margin: 10px 0; 
            border: none; 
            border-radius: 15px;
            cursor: pointer;
        }
        
        .btn-white { 
            background: white !important; 
            color: #11998e !important;
            padding: 20px; 
            width: 90%; 
            max-width: 350px; 
            font-size: 18px; 
            font-weight: bold; 
            border: none; 
            border-radius: 50px;
            margin-top: 30px;
            cursor: pointer;
        }
        
        .card { 
            background: rgba(255,255,255,0.1); 
            padding: 25px; 
            border-radius: 20px; 
            width: 90%; 
            max-width: 400px; 
            margin-bottom: 20px;
        }
        
        .id-box { 
            background: rgba(255,215,0,0.2); 
            padding: 15px; 
            border-radius: 15px; 
            margin: 15px 0;
        }
        
        .id-text { 
            font-size: 32px; 
            color: #ffd700; 
            font-weight: bold;
        }
        
        input { 
            width: 100%; 
            padding: 15px; 
            border: none; 
            border-radius: 12px; 
            font-size: 18px; 
            margin: 15px 0;
            text-align: center;
        }
        
        .btn-add { 
            background: #ffd700; 
            color: #11998e; 
            padding: 15px; 
            width: 100%; 
            font-size: 18px; 
            font-weight: bold; 
            border: none; 
            border-radius: 12px;
            cursor: pointer;
        }
        
        .friend-item { 
            background: rgba(255,255,255,0.2); 
            padding: 15px; 
            border-radius: 15px; 
            margin: 10px 0; 
            display: flex; 
            justify-content: space-between;
        }
        
        .btn-del { 
            background: #ff4757; 
            color: white; 
            border: none; 
            padding: 8px 15px; 
            border-radius: 25px;
            cursor: pointer;
        }
        
        .emergency-box { 
            background: rgba(255,255,255,0.15); 
            padding: 20px; 
            border-radius: 20px; 
            width: 90%; 
            max-width: 350px; 
            margin-top: 20px;
        }
        
        .live { 
            background: #ff4757; 
            padding: 5px 12px; 
            border-radius: 15px; 
            font-size: 12px; 
            display: inline-block;
        }
    </style>
</head>
<body id="bg" style="background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);">

    <div id="mainScreen" class="screen active">
        <button class="gear-btn" onclick="go('setScreen')">âš™ï¸</button>
        
        <h1 id="title">âœ… í˜„ì¬ ì•ˆì „í•©ë‹ˆë‹¤</h1>
        
        <button id="btn1" class="btn-dark">ëŒ€ê¸° ì¤‘...</button>
        <button id="btn2" class="btn-dark">ìˆ˜ì‹  ëŒ€ê¸° ì¤‘</button>
        
        <button id="soundBtn" class="btn-white" onclick="unlockSound()">ğŸ“± ìŠ¤ë§ˆíŠ¸ ì¹´ë©”ë¼ (ìˆ˜ì‹  ëŒ€ê¸°ì¤‘)</button>
        
        <div id="emergencyBox" class="emergency-box" style="display:none;">
            <span class="live">ğŸ”´ LIVE</span>
            <p id="friendName" style="font-size:24px; font-weight:bold; margin:10px 0;"></p>
            <p id="address" style="font-size:18px; margin:10px 0;"></p>
            <p id="time" style="font-size:14px; opacity:0.7;"></p>
            <a href="#" id="mapLink" class="btn-white" style="display:block; background:#ffd700; color:#1e3c72; text-decoration:none; text-align:center; margin-top:15px;" target="_blank">ğŸ—ºï¸ ì‹¤ì‹œê°„ ìœ„ì¹˜ í™•ì¸</a>
        </div>
        
        <button id="resetBtn" class="btn-white" style="display:none; background:#ff4757; color:white;" onclick="resetEmergency()">ìƒí™© ì¢…ë£Œ</button>
    </div>

    <div id="setScreen" class="screen">
        <h1>ì„¤ì •</h1>
        
        <div class="card">
            <p style="font-size:18px; margin-bottom:10px;">ë‚´ ê³ ìœ  ì•„ì´ë””</p>
            <div class="id-box">
                <div class="id-text" id="myId">ë¡œë”©ì¤‘...</div>
            </div>
        </div>

        <div class="card">
            <p style="font-size:18px; margin-bottom:10px;">ğŸ‘¥ ì¹œêµ¬ ë“±ë¡í•˜ê¸°</p>
            <input type="text" id="friendInput" placeholder="ì˜ˆ: SZ-A1B2" maxlength="15">
            <button class="btn-add" onclick="addFriend()">ì´ IDë¥¼ ì¹œêµ¬ë¡œ ì¶”ê°€</button>
        </div>

        <div class="card">
            <p style="font-size:18px; margin-bottom:10px;">ë“±ë¡ëœ ì¹œêµ¬ ëª©ë¡</p>
            <p style="background:rgba(255,215,0,0.3); padding:5px 15px; border-radius:15px; font-size:14px; display:inline-block; margin:10px 0;">
                <span id="count">0</span>/5ëª…
            </p>
            <div id="friendList" style="margin-top:15px;"></div>
        </div>

        <button class="btn-white" onclick="go('mainScreen')">â† ëŒì•„ê°€ê¸°</button>
    </div>

    <script>
        // ì¤Œ ì°¨ë‹¨
        document.addEventListener('gesturestart', e => e.preventDefault());
        document.addEventListener('gesturechange', e => e.preventDefault());
        document.addEventListener('gestureend', e => e.preventDefault());
        
        let lastTouch = 0;
        document.addEventListener('touchend', e => {
            const now = Date.now();
            if (now - lastTouch <= 300) e.preventDefault();
            lastTouch = now;
        }, false);

        // ID ìƒì„±
        let myID = localStorage.getItem('safeZoneID_RCV');
        if (!myID) {
            myID = 'SZ-' + Math.random().toString(36).substr(2, 4).toUpperCase();
            localStorage.setItem('safeZoneID_RCV', myID);
        }
        document.getElementById('myId').innerText = myID;

        function go(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            if(id === 'setScreen') loadFriends();
            if(id === 'mainScreen') startListening();
        }

        function addFriend() {
            const input = document.getElementById('friendInput');
            const id = input.value.trim().toUpperCase();
            if(!id) { alert('âŒ IDë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”!'); return; }
            
            let list = JSON.parse(localStorage.getItem('friendList_RCV') || '[]');
            if(list.length >= 5) { alert('âŒ ìµœëŒ€ 5ëª…ê¹Œì§€!'); return; }
            if(list.includes(id)) { alert('âŒ ì´ë¯¸ ë“±ë¡ë¨!'); return; }
            
            list.push(id);
            localStorage.setItem('friendList_RCV', JSON.stringify(list));
            input.value = '';
            alert('âœ… ë“±ë¡ ì™„ë£Œ!');
            loadFriends();
        }

        function deleteFriend(id) {
            if(!confirm('âš ï¸ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
            let list = JSON.parse(localStorage.getItem('friendList_RCV') || '[]');
            list = list.filter(f => f !== id);
            localStorage.setItem('friendList_RCV', JSON.stringify(list));
            alert('âœ… ì‚­ì œ ì™„ë£Œ!');
            loadFriends();
        }

        function loadFriends() {
            const list = JSON.parse(localStorage.getItem('friendList_RCV') || '[]');
            document.getElementById('count').innerText = list.length;
            const cont = document.getElementById('friendList');
            
            if(list.length === 0) {
                cont.innerHTML = '<p style="text-align:center; opacity:0.7; margin-top:15px;">ë“±ë¡ëœ ì¹œêµ¬ê°€ ì—†ìŠµë‹ˆë‹¤</p>';
                return;
            }
            
            cont.innerHTML = list.map(f => `
                <div class="friend-item">
                    <span>âœ… ${f}</span>
                    <button class="btn-del" onclick="deleteFriend('${f}')">âœ•</button>
                </div>
            `).join('');
        }
    </script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
        import { getDatabase, ref, onValue, remove } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCJnlwuftFUmmazQg-riYRewSeKRjBB8g",
            databaseURL: "https://safezone-2c1b2-default-rtdb.firebaseio.com",
            projectId: "safezone-2c1b2",
            appId: "1:181205095456:web:da0a519ff43cc19e7b1845"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        
        const siren = new Audio('https://actions.google.com/sounds/v1/alarms/siren_wailing.ogg');
        siren.loop = true;

        let listeners = [];
        let current = null;

        window.unlockSound = () => {
            siren.play().then(() => {
                siren.pause();
                siren.currentTime = 0;
                document.getElementById('soundBtn').innerText = "âœ… ìŠ¤í”¼ì»¤ ì¼œì§";
            }).catch(() => {});
        };

        window.startListening = function() {
            listeners.forEach(u => u());
            listeners = [];

            const list = JSON.parse(localStorage.getItem('friendList_RCV') || '[]');
            if (list.length === 0) return;

            list.forEach(fid => {
                const path = ref(db, 'emergency_signals/' + fid);
                const unsub = onValue(path, snap => {
                    const data = snap.val();
                    if (data) {
                        showEmergency(fid, data);
                    } else {
                        if (current === fid) hideEmergency();
                    }
                });
                listeners.push(unsub);
            });
        };

        function showEmergency(fid, data) {
            if (current !== fid) {
                siren.play();
                current = fid;
            }

            const body = document.getElementById('bg');
            body.className = "emergency";
            body.style.background = "linear-gradient(135deg, #ff0844 0%, #ff4757 100%)";
            
            document.getElementById('title').innerText = "ğŸš¨ ê¸´ê¸‰ ìƒí™©!!";
            document.getElementById('btn1').style.display = "none";
            document.getElementById('btn2').style.display = "none";
            document.getElementById('soundBtn').style.display = "none";
            
            document.getElementById('emergencyBox').style.display = "block";
            document.getElementById('friendName').innerText = fid;
            document.getElementById('address').innerText = data.address;
            document.getElementById('time').innerText = "ì—…ë°ì´íŠ¸: " + data.time;
            document.getElementById('mapLink').href = data.mapUrl;
            document.getElementById('resetBtn').style.display = "block";
            document.querySelector('.gear-btn').style.display = 'none';
        }

        function hideEmergency() {
            siren.pause();
            siren.currentTime = 0;
            current = null;
            
            const body = document.getElementById('bg');
            body.className = "";
            body.style.background = "linear-gradient(135deg, #11998e 0%, #38ef7d 100%)";
            
            document.getElementById('title').innerText = "âœ… í˜„ì¬ ì•ˆì „í•©ë‹ˆë‹¤";
            document.getElementById('btn1').style.display = "block";
            document.getElementById('btn2').style.display = "block";
            document.getElementById('soundBtn').style.display = "block";
            document.getElementById('emergencyBox').style.display = "none";
            document.getElementById('resetBtn').style.display = "none";
            document.querySelector('.gear-btn').style.display = 'block';
        }
        
        window.resetEmergency = () => {
            const list = JSON.parse(localStorage.getItem('friendList_RCV') || '[]');
            list.forEach(fid => remove(ref(db, 'emergency_signals/' + fid)));
            hideEmergency();
        };

        startListening();
        loadFriends();
    </script>
</body>
</html>
