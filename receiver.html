<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì•ˆì „ì§€ëŒ€ ìˆ˜ì‹ ì†Œ</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: sans-serif; }
        body { height: 100vh; display: flex; flex-direction: column; align-items: center; justify-content: center; color: white; text-align: center; transition: background 0.5s; padding: 20px; }
        
        .safe { background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); }
        .emergency { background: linear-gradient(135deg, #ff0844 0%, #ff4757 100%); animation: blink 1s infinite alternate; }
        @keyframes blink { from { opacity: 1; } to { opacity: 0.8; } }

        h1 { font-size: 40px; margin-bottom: 20px; font-weight: 900; }
        p { font-size: 24px; margin: 10px 0; background: rgba(0,0,0,0.2); padding: 15px; border-radius: 10px; width: 100%; max-width: 400px; }
        
        /* ì£¼ì†Œë¥¼ ë³´ì—¬ì£¼ëŠ” íŠ¹ë³„í•œ ë°•ìŠ¤ ë””ìì¸ */
        #addressBox { display: none; margin: 15px 0; background: rgba(0,0,0,0.6); padding: 20px; border-radius: 15px; width: 100%; max-width: 400px; border: 2px solid #ffd700; }
        .addr-title { font-size: 18px; color: #ffd700; margin-bottom: 5px; font-weight: bold; }
        .addr-text { font-size: 22px; line-height: 1.4; word-break: keep-all; }
        .coord-text { font-size: 14px; opacity: 0.7; margin-top: 10px; }
        
        /* ì§€ë„ ë°”ë¡œê°€ê¸° ë²„íŠ¼ */
        #mapBtn { display: none; margin-top: 10px; padding: 15px 30px; font-size: 20px; font-weight: bold; color: #1e3c72; background: #ffd700; border-radius: 50px; text-decoration: none; box-shadow: 0 5px 15px rgba(0,0,0,0.3); }

        #startSoundBtn {
            margin-top: 30px; padding: 20px 40px; font-size: 22px; font-weight: bold;
            color: white; background: rgba(0,0,0,0.5); border: 2px solid white; border-radius: 50px;
            cursor: pointer; box-shadow: 0 10px 20px rgba(0,0,0,0.3);
        }

        #resetBtn {
            display: none; 
            margin-top: 30px; padding: 20px 40px; font-size: 24px; font-weight: bold;
            color: #ff4757; background: white; border: none; border-radius: 50px;
            cursor: pointer; box-shadow: 0 10px 20px rgba(0,0,0,0.3);
        }
    </style>
</head>
<body id="bg" class="safe">

    <h1 id="statusText">âœ… í˜„ì¬ ì•ˆì „í•©ë‹ˆë‹¤</h1>
    <p id="timeText">ëŒ€ê¸° ì¤‘...</p>
    <p id="msgText">ìˆ˜ì‹  ëŒ€ê¸° ì¤‘</p>
    
    <div id="addressBox">
        <div class="addr-title">ğŸš¨ êµ¬ì¡° ìœ„ì¹˜ (ì§€ë²ˆ/ë„ë¡œëª…)</div>
        <div id="addressText" class="addr-text"></div>
        <div id="coordText" class="coord-text"></div>
    </div>
    
    <a href="#" id="mapBtn" target="_blank">ğŸ—ºï¸ ì¹´ì¹´ì˜¤ ì§€ë„ë¡œ ê¸¸ì°¾ê¸°</a>

    <button id="startSoundBtn" onclick="unlockSound()">ğŸ”Š í„°ì¹˜í•´ì„œ ìŠ¤í”¼ì»¤ ì¼œê¸°</button>
    <button id="resetBtn" onclick="resetEmergency()">ìƒí™© ì¢…ë£Œ (ì•ŒëŒ ë„ê¸°)</button>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
        import { getDatabase, ref, onValue, remove } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCJnlwuftFUmmazQg-riYRewSeKRjBB8g",
            authDomain: "safezone-2c1b2.firebaseapp.com",
            databaseURL: "https://safezone-2c1b2-default-rtdb.firebaseio.com",
            projectId: "safezone-2c1b2",
            storageBucket: "safezone-2c1b2.firebasestorage.app",
            messagingSenderId: "181205095456",
            appId: "1:181205095456:web:da0a519ff43cc19e7b1845",
            measurementId: "G-X6QBMSL7DS"
        };

        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);
        const emergencyRef = ref(database, 'emergency_signal');

        // í•¸ë“œí° ë‚´ì¥ ë¶€ì € ì—”ì§„ ì¤€ë¹„!
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        window.sirenOscillator = null;
        window.sirenInterval = null;

        // ìŠ¤í”¼ì»¤ ì‹œë™ ê±¸ê¸°
        window.unlockSound = function() {
            audioCtx.resume(); 
            
            const ut = new SpeechSynthesisUtterance("ìˆ˜ì‹  ëŒ€ê¸°ë¥¼ ì‹œì‘í•©ë‹ˆë‹¤.");
            ut.lang = 'ko-KR';
            window.speechSynthesis.speak(ut);
            
            document.getElementById('startSoundBtn').innerText = "âœ… ìŠ¤í”¼ì»¤ ì¼œì§ (ìˆ˜ì‹  ëŒ€ê¸°ì¤‘)";
            document.getElementById('startSoundBtn').style.background = "white";
            document.getElementById('startSoundBtn').style.color = "#11998e";
            document.getElementById('startSoundBtn').onclick = null; 
        };

        // [ì‹¤ì‹œê°„ ê°ì‹œ]
        onValue(emergencyRef, (snapshot) => {
            const data = snapshot.val();
            
            if (data) {
                // 1. í…ìŠ¤íŠ¸ ì •ë³´ ì—…ë°ì´íŠ¸
                document.getElementById('statusText').innerText = "ğŸš¨ ê¸´ê¸‰ ìƒí™© ë°œìƒ!!";
                document.getElementById('timeText').innerText = "ì‹œê°„: " + data.time;
                document.getElementById('msgText').innerText = data.message;
                
                // 2. ğŸ“ ì§€ë²ˆ ì£¼ì†Œ ë° ì¢Œí‘œ í‘œì‹œ ë¡œì§ (ìƒˆë¡œ ì¶”ê°€ë¨)
                if(data.address && data.lat && data.lon) {
                    document.getElementById('addressBox').style.display = "block";
                    document.getElementById('addressText').innerText = data.address;
                    document.getElementById('coordText').innerText = `(ì¢Œí‘œ: ${data.lat.toFixed(4)}, ${data.lon.toFixed(4)})`;
                    
                    document.getElementById('mapBtn').style.display = "inline-block";
                    document.getElementById('mapBtn').href = data.mapUrl;
                }
                
                // 3. ë°°ê²½ìƒ‰ ë³€ê²½ ë° ë²„íŠ¼ í† ê¸€
                document.getElementById('bg').className = "emergency";
                document.getElementById('resetBtn').style.display = "block"; 
                document.getElementById('startSoundBtn').style.display = "none";

                // ğŸš¨ 4. ê¸°ê³„ìŒ ì‚¬ì´ë Œ
                if(!window.sirenOscillator) {
                    window.sirenOscillator = audioCtx.createOscillator();
                    window.sirenOscillator.type = 'square'; 
                    window.sirenOscillator.connect(audioCtx.destination);
                    window.sirenOscillator.start();
                    
                    window.sirenInterval = setInterval(() => {
                        window.sirenOscillator.frequency.value = window.sirenOscillator.frequency.value === 800 ? 1200 : 800;
                    }, 500);
                }

                // ğŸ”Š 5. ì§„ì§€í•œ ìƒí™© ì•ˆë‚´ ëª©ì†Œë¦¬
                const ut = new SpeechSynthesisUtterance("ì¥í™”ë‹˜ì˜ ê¸´ê¸‰ êµ¬ì¡° ìš”ì²­ì…ë‹ˆë‹¤. ì¦‰ì‹œ ìœ„ì¹˜ë¥¼ í™•ì¸í•˜ì‹­ì‹œì˜¤.");
                ut.lang = 'ko-KR';
                window.speechSynthesis.speak(ut);
                
            } else {
                // í‰ìƒì‹œ ìƒíƒœë¡œ ì´ˆê¸°í™”
                document.getElementById('statusText').innerText = "âœ… í˜„ì¬ ì•ˆì „í•©ë‹ˆë‹¤";
                document.getElementById('timeText').innerText = "ëŒ€ê¸° ì¤‘...";
                document.getElementById('msgText').innerText = "ìˆ˜ì‹  ëŒ€ê¸° ì¤‘";
                document.getElementById('bg').className = "safe";
                
                // ì£¼ì†Œì™€ ì§€ë„ ë²„íŠ¼ ìˆ¨ê¸°ê¸°
                document.getElementById('addressBox').style.display = "none";
                document.getElementById('mapBtn').style.display = "none";
                
                document.getElementById('resetBtn').style.display = "none"; 
                document.getElementById('startSoundBtn').style.display = "block"; 
            }
        });

        // ìƒí™© ì¢…ë£Œ ë²„íŠ¼
        window.resetEmergency = function() {
            if(window.sirenOscillator) {
                window.sirenOscillator.stop();
                clearInterval(window.sirenInterval);
                window.sirenOscillator = null;
            }
            remove(emergencyRef); 
        };
    </script>
</body>
</html>
