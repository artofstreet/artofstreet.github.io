<!DOCTYPE html>
<html lang="ko" style="background: #2b2b85;">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#2b2b85">
    <title>ì•ˆì „ì§€ëŒ€ V16.7 (ì•ˆë“œë¡œì´ë“œ ì™„ë²½ ë³´ì •)</title>
    
    <script type="text/javascript" src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=5d19f896badf6fdab5297f129bffaf1e&libraries=services"></script>
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: sans-serif; -webkit-user-select: none; user-select: none; -webkit-tap-highlight-color: transparent; outline: none !important; }
        html, body { width: 100%; height: 100%; overflow: hidden; position: fixed; touch-action: manipulation; }
        body { background: #2b2b85 !important; color: white; }
        
        /* ë²„íŠ¼ì„ ëˆ„ë¥¼ ë•Œ ì‘¥ ë“¤ì–´ê°€ëŠ” ì…ì²´ íš¨ê³¼ */
        button:active { transform: scale(0.88) !important; filter: brightness(0.8); transition: 0.1s; }

        .mode-toggle { position: fixed; top: 0; left: 0; right: 0; height: 100px; display: flex; align-items: center; justify-content: center; font-size: 28px; font-weight: 900; cursor: pointer; z-index: 9999; box-shadow: 0 4px 15px rgba(0,0,0,0.3); border: none; }
        .mode-toggle.sender { background: linear-gradient(135deg, #ffd700 0%, #ffed4e 100%); color: #2b2b85; }
        .mode-toggle.receiver { background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); color: white; }
        
        .app-screen { display: none; width: 100%; height: calc(100% - 100px); position: absolute; top: 100px; flex-direction: column; align-items: center; justify-content: center; }
        .app-screen.active { display: flex; }
        
        .btn-emergency { width: 260px; height: 260px; background: #f90b3e; border-radius: 50%; border: 10px solid rgba(255,255,255,0.2); color: white; font-size: 46px; font-weight: 900; box-shadow: 0 20px 50px rgba(249, 11, 62, 0.6); cursor: pointer; transition: 0.1s; }
        .btn-emergency.tracking { background: #ff6b6b; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }

        /* ìƒíƒœ í™•ì¸ì°½ */
        #statusPanel { position: fixed; bottom: 0; left: 0; right: 0; background: rgba(0,0,0,0.95); color: #00ff00; font-family: monospace; font-size: 14px; padding: 15px; max-height: 200px; overflow-y: auto; z-index: 99999; display: none; border-top: 3px solid #00ff00; }
        .status-header { background: #00ff00; color: black; padding: 5px 10px; font-weight: bold; border-radius: 4px; margin-bottom: 8px; }

        #map { width: 90%; height: 300px; border-radius: 20px; margin-top: 20px; border: 3px solid white; }
        .btn-white { background: white; color: #11998e; padding: 20px; width: 90%; border-radius: 50px; font-size: 24px; font-weight: 900; margin-top: 15px; border: none; }
    </style>
</head>
<body>

    <div id="modeToggle" class="mode-toggle sender">ğŸ”„ í˜„ì¬: êµ¬ì¡° ìš”ì²­ ëª¨ë“œ</div>

    <div id="senderScreen" class="app-screen active">
        <button id="emergencyBtn" class="btn-emergency">ê¸´ê¸‰êµ¬ì¡°</button>
        <p id="msg" style="margin-top:30px; font-size:24px; color:#ffd700;">ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ ì§„ë™ì´ ì˜µë‹ˆë‹¤</p>
        <button class="btn-white" style="background:#00c8ff; color:white;" onclick="toggleStatus()">ğŸ” ì‹œìŠ¤í…œ ìƒíƒœ í™•ì¸</button>
    </div>

    <div id="receiverScreen" class="app-screen">
        <h1 id="receiverTitle" style="font-size:32px; margin-bottom:20px;">âœ… ìˆ˜ì‹  ëŒ€ê¸° ì¤‘</h1>
        <div id="map"></div>
        <button id="soundBtn" class="btn-white">ğŸ”Š ì†Œë¦¬ ì¼œê¸° (ì¤€ë¹„ í•„ìˆ˜)</button>
        <div id="infoCard" style="display:none; margin-top:20px; background:rgba(255,255,255,0.2); padding:20px; border-radius:20px; width:90%;">
            <p id="addrText" style="font-size:22px; font-weight:bold;"></p>
        </div>
        <button class="btn-white" style="background:#00c8ff; color:white;" onclick="toggleStatus()">ğŸ” ì‹œìŠ¤í…œ ìƒíƒœ í™•ì¸</button>
    </div>

    <div id="statusPanel">
        <div class="status-header">ğŸ“¡ ì‹œìŠ¤í…œ ì—°ê²° ë° ì‘ë™ ìƒíƒœ</div>
        <div id="statusContent"></div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
        import { getDatabase, ref, set, remove, onValue } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCJnlwuftFUmmazQg-riYRewSeKRjBB8g",
            databaseURL: "https://safezone-2c1b2-default-rtdb.firebaseio.com",
            projectId: "safezone-2c1b2",
            appId: "1:181205095456:web:da0a519ff43cc19e7b1845"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const geocoder = new kakao.maps.services.Geocoder();

        window.log = (m) => {
            const c = document.getElementById('statusContent');
            c.innerHTML += `<div>[${new Date().toLocaleTimeString()}] ${m}</div>`;
            document.getElementById('statusPanel').scrollTop = 9999;
        };

        // ë°œì‹  ID ê³ ì •
        const myId = "SZ-BKPX"; 
        log("ë‚´ ê³ ìœ  ë°œì‹  ID: " + myId);

        const btn = document.getElementById('emergencyBtn');
        
        // ì•ˆë“œë¡œì´ë“œ ì§„ë™ ë° í„°ì¹˜ ì™„ë²½ ë³´ì •
        btn.addEventListener('touchstart', (e) => {
            e.preventDefault();
            if (navigator.vibrate) navigator.vibrate([300, 100, 300]); // ì§•-ì§•-ì§•
            log("ğŸ‘† ë²„íŠ¼ í„°ì¹˜! ì§„ë™ ë°œìƒ");
        });

        btn.addEventListener('click', () => {
            if(!window.isTracking) start(); else stop();
        });

        window.isTracking = false;
        function start() {
            window.isTracking = true;
            btn.classList.add('tracking');
            btn.innerText = "ì¤‘ì§€";
            log("ğŸš¨ ì‹ í˜¸ ë°œì†¡ ì‹œì‘!");
            
            navigator.geolocation.watchPosition((pos) => {
                const lat = pos.coords.latitude, lon = pos.coords.longitude;
                geocoder.coord2Address(lon, lat, (res, stat) => {
                    const addr = stat === kakao.maps.services.Status.OK ? res[0].address.address_name : "ìœ„ì¹˜ íŒŒì•… ì¤‘";
                    set(ref(db, 'emergency_signals/' + myId), { lat, lon, address: addr, time: new Date().toLocaleString() });
                    log("ğŸ“ ìœ„ì¹˜ ì „ì†¡: " + addr);
                });
            }, null, { enableHighAccuracy: true });
        }

        function stop() {
            window.isTracking = false;
            btn.classList.remove('tracking');
            btn.innerText = "ê¸´ê¸‰êµ¬ì¡°";
            remove(ref(db, 'emergency_signals/' + myId));
            log("ğŸ›‘ ì‹ í˜¸ ì¢…ë£Œ");
            location.reload();
        }

        // ìˆ˜ì‹  ë¡œì§
        const siren = new Audio('https://actions.google.com/sounds/v1/alarms/siren_wailing.ogg');
        siren.loop = true;
        document.getElementById('soundBtn').onclick = () => {
            siren.play().then(() => { siren.pause(); log("ğŸ”Š ì†Œë¦¬ ì¤€ë¹„ ì™„ë£Œ!"); document.getElementById('soundBtn').style.background = "#00ff00"; });
        };

        // ìˆ˜ì‹  í™•ì¸ (ê°€ì¡± í•¸ë“œí°ìš©)
        // ìˆ˜ì‹  ëª¨ë“œì¼ ë•Œ ìŠ¤ë¥´ì‚¬ë§ˆì˜ ID(SZ-BKPX)ë¥¼ ê°ì‹œí•©ë‹ˆë‹¤.
        onValue(ref(db, 'emergency_signals/SZ-BKPX'), (snap) => {
            const data = snap.val();
            if (data) {
                log("ğŸš¨ ìŠ¤ë¥´ì‚¬ë§ˆì˜ ê¸´ê¸‰ ì‹ í˜¸ ìˆ˜ì‹ !");
                siren.play();
                document.getElementById('receiverScreen').style.background = "red";
                document.getElementById('infoCard').style.display = "block";
                document.getElementById('addrText').innerText = "ìœ„ì¹˜: " + data.address;
                // ì§€ë„ í‘œì‹œ ë¡œì§...
            } else {
                siren.pause();
                document.getElementById('receiverScreen').style.background = "";
            }
        });

        window.toggleStatus = () => {
            const p = document.getElementById('statusPanel');
            p.style.display = p.style.display === 'none' ? 'block' : 'none';
        };

        // ëª¨ë“œ ì „í™˜
        document.getElementById('modeToggle').onclick = () => {
            const s = document.getElementById('senderScreen'), r = document.getElementById('receiverScreen');
            if(s.classList.contains('active')) {
                s.classList.remove('active'); r.classList.add('active');
                document.getElementById('modeToggle').innerText = "ğŸ”„ í˜„ì¬: ê°€ì¡± ë³´í˜¸ ëª¨ë“œ";
            } else {
                r.classList.remove('active'); s.classList.add('active');
                document.getElementById('modeToggle').innerText = "ğŸ”„ í˜„ì¬: êµ¬ì¡° ìš”ì²­ ëª¨ë“œ";
            }
        };
    </script>
</body>
</html>
