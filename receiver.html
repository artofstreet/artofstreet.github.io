<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#2b2b85">
    <title>ì•ˆì „ì§€ëŒ€ ìˆ˜ì‹ ì†Œ V11.1</title>
    
    <link rel="manifest" href="manifest-receiver.json">
    <script type="text/javascript" src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=5d19f896badf6fdab5297f129bffaf1e&libraries=services"></script>
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: sans-serif; }
        body { 
            height: 100vh; background: #2b2b85; color: white; text-align: center; 
            display: flex; justify-content: center; align-items: center; overflow: hidden; 
            touch-action: none; /* í™”ë©´ í”ë“¤ë¦¼ ë°©ì§€ */
            -webkit-user-select: none; user-select: none; /* ê¸€ì ì„ íƒ ë°©ì§€ */
        }
        
        .screen { display: none; width: 100%; height: 100%; flex-direction: column; align-items: center; position: absolute; top: 0; left: 0; padding: 20px; background: #2b2b85; }
        .active { display: flex !important; }

        .header { width: 100%; padding: 15px 0; display: flex; justify-content: space-between; align-items: center; }
        .gear-btn { width: 50px; height: 50px; background: rgba(255,255,255,0.2); border: none; border-radius: 50%; font-size: 24px; cursor: pointer; }

        .card { background: rgba(255,255,255,0.1); padding: 20px; border-radius: 20px; width: 100%; max-width: 400px; margin-bottom: 15px; backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.2); }
        .status-badge { display: inline-block; padding: 6px 15px; border-radius: 20px; font-size: 14px; font-weight: bold; margin-bottom: 10px; }
        .status-safe { background: #2ecc71; color: white; }
        .status-emergency { background: #f90b3e; color: white; animation: blink 1s infinite; }
        @keyframes blink { 50% { opacity: 0.5; } }

        /* ì§€ë„ ì˜ì—­: ë†’ì´ë¥¼ í™•ì‹¤íˆ ì§€ì •í•˜ì—¬ ëš«ë ¤ ë³´ì´ì§€ ì•Šê²Œ í•¨ */
        #map { width: 100%; height: 320px; border-radius: 15px; margin: 15px 0; border: 2px solid rgba(255,255,255,0.3); background: #333; }

        .input-box { width: 100%; padding: 15px; border-radius: 12px; border: none; font-size: 18px; margin: 10px 0; text-align: center; }
        .btn-yellow { background: #ffd700; color: #2b2b85; padding: 15px; width: 100%; font-size: 18px; font-weight: bold; border-radius: 12px; border: none; }
        .friend-item { background: rgba(255,255,255,0.1); padding: 12px; border-radius: 12px; margin: 8px 0; display: flex; justify-content: space-between; width: 100%; }
        .btn-pill { background: white; color: #2b2b85; padding: 18px; width: 100%; max-width: 300px; font-size: 20px; font-weight: bold; border-radius: 50px; border: none; margin-top: 20px; }
    </style>
</head>
<body>

    <div id="mainScreen" class="screen active">
        <div class="header">
            <h2 style="font-size: 18px;">ğŸ“¡ ìˆ˜ì‹  ëª¨ë‹ˆí„°ë§ (V11.1)</h2>
            <button class="gear-btn" onclick="go('setScreen')">âš™ï¸</button>
        </div>
        
        <div class="card">
            <div id="statusBadge" class="status-badge status-safe">ì •ìƒ ì‘ë™ ì¤‘</div>
            <p id="senderName" style="font-size: 22px; font-weight: 900; color: #ffd700;">ëŒ€ê¸° ì¤‘...</p>
            <p id="senderAddr" style="font-size: 14px; opacity: 0.8; margin-top: 5px;">ì‹ í˜¸ë¥¼ ê¸°ë‹¤ë¦¬ê³  ìˆìŠµë‹ˆë‹¤.</p>
            <div id="map"></div>
        </div>
        <p style="font-size: 12px; opacity: 0.5;">ë°œì‹ ì†Œ 5ëª… ì§‘ì¤‘ ê´€ë¦¬ ì¤‘</p>
    </div>

    <div id="setScreen" class="screen">
        <h1 style="margin-bottom: 20px;">ìˆ˜ì‹  ì„¤ì •</h1>
        <div class="card">
            <p>ğŸ¤ ë°œì‹ ì ID ë“±ë¡ (ìµœëŒ€ 5ëª…)</p>
            <input type="text" id="targetID" class="input-box" placeholder="SZ-XXXX">
            <button class="btn-yellow" onclick="addTarget()">ì¶”ê°€í•˜ê¸°</button>
        </div>
        <div id="targetList" style="width: 100%; max-width: 400px;"></div>
        <button class="btn-pill" onclick="go('mainScreen')">â† ëŒì•„ê°€ê¸°</button>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
        import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCJnlwuftFUmmazQg-riYRewSeKRjBB8g",
            databaseURL: "https://safezone-2c1b2-default-rtdb.firebaseio.com",
            projectId: "safezone-2c1b2",
            appId: "1:181205095456:web:da0a519ff43cc19e7b1845"
        };
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        let map, marker;

        window.go = function(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            if(id === 'setScreen') loadTargets();
        };

        window.addTarget = function() {
            const input = document.getElementById('targetID');
            const id = input.value.trim().toUpperCase();
            if(!id) return;
            let list = JSON.parse(localStorage.getItem('friendList_REC') || '[]');
            if(list.length >= 5) { alert("ìµœëŒ€ 5ëª…ê¹Œì§€ë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤."); return; }
            if(!list.includes(id)) list.push(id);
            localStorage.setItem('friendList_REC', JSON.stringify(list));
            input.value = "";
            loadTargets();
        };

        window.loadTargets = function() {
            const list = JSON.parse(localStorage.getItem('friendList_REC') || '[]');
            const cont = document.getElementById('targetList');
            cont.innerHTML = list.map(f => `<div class="friend-item"><span>ğŸ“¡ ${f}</span><button onclick="deleteTarget('${f}')" style="color:#ff4757;background:none;border:none;font-size:20px;">âœ•</button></div>`).join('');
        };

        window.deleteTarget = function(id) {
            let list = JSON.parse(localStorage.getItem('friendList_REC') || '[]');
            list = list.filter(f => f !== id);
            localStorage.setItem('friendList_REC', JSON.stringify(list));
            loadTargets();
        };

        // ì§€ë„ê°€ í™•ì‹¤íˆ ë¡œë”©ë˜ë„ë¡ í•˜ëŠ” í•¨ìˆ˜
        function initMap() {
            const container = document.getElementById('map');
            const options = { center: new kakao.maps.LatLng(37.5665, 126.9780), level: 3 };
            map = new kakao.maps.Map(container, options);
            marker = new kakao.maps.Marker({ position: map.getCenter() });
            marker.setMap(map);
            startMonitoring();
        }

        function startMonitoring() {
            const list = JSON.parse(localStorage.getItem('friendList_REC') || '[]');
            list.forEach(id => {
                onValue(ref(db, 'emergency_signals/' + id), (snapshot) => {
                    const data = snapshot.val();
                    if(data) {
                        document.getElementById('statusBadge').className = "status-badge status-emergency";
                        document.getElementById('statusBadge').innerText = "ğŸš¨ ê¸´ê¸‰ ìƒí™© ë°œìƒ!";
                        document.getElementById('senderName').innerText = data.sender;
                        document.getElementById('senderAddr').innerText = data.address;
                        const pos = new kakao.maps.LatLng(data.lat, data.lon);
                        map.setCenter(pos);
                        marker.setPosition(pos);
                    }
                });
            });
        }

        // ìŠ¤í¬ë¦½íŠ¸ ë¡œë”© í›„ ì§€ë„ ì‹œì‘
        window.addEventListener('load', initMap);
    </script>
</body>
</html>
